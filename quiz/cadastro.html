<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Quiz do Consumidor — mobile test</title>
<meta name="theme-color" content="#24A653" />

<style>
:root{
  --brand:#24A653; --brand-hi:#8ff5c1;
  --accent:#FFDA3A; --danger:#E5242A;
  --bg:#0b0b16; --panel:#0f1330cc; --ink:#ecf2ff; --muted:#a9b7d7;
  --ans:#19214a; --ans-ok:#0f6a2f; --ans-bad:#7a1f2e;
  --ring:#ffffff24; --radius:16px; --gap:12px; --vh:1vh;
  color-scheme: dark;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;max-width:100vw}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif;overflow-x:hidden;overflow-y:auto}

/* Palco */
.stage{
  min-height: calc(var(--vh) * 100);
  width:100%;
  display:flex; flex-direction:column;
  background:
    radial-gradient(900px 700px at 80% -10%, #17224b 0%, transparent 60%),
    radial-gradient(600px 600px at 15% 10%, #111a3d 0%, transparent 60%),
    var(--bg);
}

/* Header compacto */
.header{
  height:48px; display:flex; align-items:center; justify-content:space-between;
  padding: 0 10px;
  background: linear-gradient(180deg,#0e1436aa,#0b102c99);
  border-bottom:1px solid var(--ring); backdrop-filter: blur(6px);
  position:sticky; top:0; z-index:10; gap:8px;
}
.h-left{display:flex; align-items:center; gap:8px; min-width:0; flex:1 1 auto}
.h-right{display:flex; align-items:center; gap:6px; flex:0 0 auto}

/* Logo pequena no mobile */
.logoImg{ height:40px; width:auto; display:block; image-rendering:-webkit-optimize-contrast; }
@media (min-width:420px){ .logoImg{ height:40px } }
@media (min-width:480px){ .logoImg{ height:40px } }

/* Controles */
.minibtn{
  height:30px; padding:0 8px; font-weight:800; font-size:12px;
  border:3px solid #000; border-radius:10px; box-shadow:0 4px 0 #000;
  cursor:pointer; background:#1a204a; color:#fff; line-height:30px;
}
.minibtn.danger{background:linear-gradient(180deg,var(--danger),#8b1017)}
.select{
  appearance:none; background:#0d1130; color:#fff;
  border:3px solid #000; border-radius:10px; height:30px; font-weight:800; font-size:11px;
  padding:0 6px; max-width:36vw; text-overflow:ellipsis;
}
@media (max-width:380px){ .select{ max-width:30vw; font-size:10px; padding:0 5px } }

/* Conteúdo */
.screen{display:grid;place-items:start;padding:12px}
.kiosk{
  width:min(720px, 100%);
  margin: 10px auto 16px;
  background: linear-gradient(180deg, var(--panel), #0f1338e0);
  border:4px solid #000;border-radius:var(--radius);
  box-shadow:0 14px 40px rgba(0,0,0,.45);
  position:relative; overflow:visible;
}
.bggrid{position:absolute; inset:0; opacity:.22; pointer-events:none;
  background:
    linear-gradient(transparent 95%, rgba(255,255,255,.06) 95%) 0 0/100% 28px,
    linear-gradient(90deg, transparent 95%, rgba(255,255,255,.06) 95%) 0 0/28px 100%;
  border-radius:inherit;
}

/* HUD */
.hud{display:flex; justify-content:center; align-items:center; gap:12px; padding:12px 10px 2px}
.timerWrap{position:relative;width:84px;height:84px;display:grid;place-items:center}
.timerSvg{transform:rotate(-90deg)} .timerRingBg{stroke:#000;opacity:.5}
.timerRing{stroke:var(--accent);transition:stroke-dashoffset .25s linear}
.timerNum{position:absolute;font-weight:900;font-size:20px}
.badge{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;background:#0d1130;border:3px solid #000;border-radius:12px;box-shadow:inset 0 -4px 0 rgba(0,0,0,.45),0 4px 0 #000;font-weight:900;font-size:14px}

/* Corpo */
.body{display:grid; gap:12px; padding:12px}
.title{font-weight:900; font-size: clamp(20px, 3.4vh, 28px); color:var(--accent); text-align:center; text-shadow: 0 3px 0 #000, 0 0 12px rgba(255,218,58,.3)}
.q{font-weight:800; font-size: clamp(18px, 2.6vh, 22px); text-align:center; text-shadow:0 2px 0 #000}
.answers{display:grid; grid-template-columns:1fr; gap:12px; align-content:start}
.answer{
  display:flex; align-items:center; gap:12px; min-height:64px;
  padding:14px; text-align:left; background:var(--ans); color:#fff;
  border:4px solid #000; border-radius:14px; box-shadow:0 8px 0 #000;
  font-weight:800; font-size:16px; cursor:pointer; user-select:none; touch-action: manipulation;
}
.answer:active{transform:translateY(3px)}
.key{display:grid;place-items:center;width:36px;height:36px;min-width:36px;border:3px solid #333;border-radius:10px;background:#000;color:var(--accent);font-weight:900}
.answer.correct{background:var(--ans-ok)}
.answer.wrong{background:var(--ans-bad)}
.answer.disabled{opacity:.6; pointer-events:none}

/* Progresso */
.progress{width:88%; height:10px; margin:6px auto 2px; background:#000; border:4px solid #000; border-radius:9px; overflow:hidden}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand-hi));width:0%}

/* Rodapé interno / “Brinde” oculto */
.footerBox{display:flex;justify-content:center;align-items:center;gap:10px;padding:12px}
.prize{padding:8px 10px;border:3px dashed #000;border-radius:12px;background: linear-gradient(180deg, #16205b, #0e1541); font-weight:900; font-size:14px}
#prizeBox, #footPrize { display:none; } /* ocultar “Brinde” */

/* Botões */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;
  background:linear-gradient(180deg,var(--brand),color-mix(in oklab,var(--brand) 70%, #000));
  color:#021;padding:14px 18px;border:4px solid #000;border-radius:14px;
  font-weight:900;font-size:16px; box-shadow:0 8px 0 #000; cursor:pointer; min-height:52px;
}
.btn.alt{background:linear-gradient(180deg,var(--accent),#b48a1d); color:#311}
.btn.danger{background:linear-gradient(180deg,var(--danger),#8b1017); color:#fff}
.btn.ghost{background:#0d1130; color:#fff}
.btn:active{transform:translateY(3px); box-shadow:0 5px 0 #000}

/* Inputs */
.input{
  width:100%; padding:14px 16px; border:4px solid #000; border-radius:12px;
  background:#0d1130; color:#fff; font-weight:800; font-size:16px;
  box-shadow:inset 0 -4px 0 rgba(0,0,0,.45),0 4px 0 #000;
}
.input::placeholder{color:#8892b0}
.formGrid{display:grid; grid-template-columns:1fr; gap:10px; margin-bottom:8px}

/* WhatsApp prefixo */
.whatsRow{display:flex;align-items:center;gap:6px}
.whatsPrefix{font-weight:900;font-size:16px;color:var(--muted);background:#0d1130;border:4px solid #000;border-radius:12px;padding:0 10px;height:52px;display:grid;place-items:center}

/* Linha de ações: centraliza INICIAR */
.formRow{ display:grid; grid-template-columns:1fr; gap:10px; justify-items:center; }
.formRow .btn#btnStart{ width:min(260px, 70%); }

/* Footer global */
.footer{display:flex;justify-content:center;align-items:center;height:40px;border-top:1px solid var(--ring);color:var(--muted);font-size:12px}

/* esconde o seletor de tema padrão (mantido no HTML se quiser reativar) */
.select{ display:none; }

/* ---------- KIOSK MODE (totem vertical 43") ---------- */
html.kiosk-on .logoImg{ height:48px; }
html.kiosk-on .kiosk{
  width:min(980px, 96vw);
  min-height: calc(var(--vh) * 0.92);
}
html.kiosk-on .title{ font-size: clamp(26px, 3.8vh, 40px); }
html.kiosk-on .q{     font-size: clamp(22px, 3.0vh, 30px); }
html.kiosk-on .input,
html.kiosk-on .btn,
html.kiosk-on .answer{ font-size: clamp(18px, 2.2vh, 22px); }
html.kiosk-on .answer{ min-height: 72px; }
html.kiosk-on .btn{   min-height: 60px; }
html.kiosk-on .timerWrap{ width:100px; height:100px; }
html.kiosk-on .hud{ padding-top:16px; }
html.kiosk-on .body{ gap: clamp(12px, 2vh, 22px); }
html.kiosk-on .footer{ margin-top: 6px; }

/* ===================== MODO CLARO (High-Ambient) ===================== */
:root[data-theme="light"]{
  --bg:#f7f9fc;
  --panel:#ffffffcc;
  --ink:#0e1320;
  --muted:#5a6478;
  --ring:#00000018;

  --brand:#24A653; --brand-hi:#0bbd64;
  --accent:#C28B00;
  --danger:#C81E24;

  --ans:#eef2f9;
  --ans-ok:#e6f7ed;
  --ans-bad:#fdecef;

  color-scheme: light;
}
:root[data-theme="light"] .stage{
  background:
    radial-gradient(900px 700px at 80% -10%, #ffffff 0%, transparent 60%),
    radial-gradient(600px 600px at 15% 10%, #ffffff 0%, transparent 60%),
    var(--bg);
}
:root[data-theme="light"] .kiosk{
  background: linear-gradient(180deg, var(--panel), #ffffffee);
  border-color:#1e2a3a20;
  box-shadow:0 8px 28px rgba(0,0,0,.12);
}
:root[data-theme="light"] .header{
  background: linear-gradient(180deg,#ffffffd9,#ffffffc2);
  border-bottom:1px solid var(--ring);
  backdrop-filter:saturate(1.2) blur(8px);
}
:root[data-theme="light"] .title{ color:#C28B00; text-shadow:none; }
:root[data-theme="light"] .q{ text-shadow:none; color:var(--ink); }
:root[data-theme="light"] .badge{
  background:#f1f4fa; border-color:#00000022;
  box-shadow:inset 0 -3px 0 #00000010, 0 3px 0 #00000022;
  color:var(--ink);
}
:root[data-theme="light"] .input{
  background:#ffffff; color:var(--ink);
  border-color:#00000022;
  box-shadow:inset 0 -3px 0 #00000010, 0 3px 0 #00000022;
}
:root[data-theme="light"] .whatsPrefix{ background:#ffffff; border-color:#00000022; }
:root[data-theme="light"] .minibtn{
  background:#ffffff; color:#1d2636;
  border-color:#00000022; box-shadow:0 3px 0 #00000022;
}
:root[data-theme="light"] .answer{
  background:var(--ans); color:#0e1320;
  border-color:#00000022; box-shadow:0 6px 0 #00000022;
}
:root[data-theme="light"] .answer.correct{ background:var(--ans-ok); }
:root[data-theme="light"] .answer.wrong{   background:var(--ans-bad); }
:root[data-theme="light"] .key{
  background:#ffffff; color:#C28B00; border-color:#00000022;
}
:root[data-theme="light"] .btn{
  color:#042; border-color:#00000022; box-shadow:0 6px 0 #00000022;
}
:root[data-theme="light"] .btn.alt{
  background: linear-gradient(180deg,#FFDA3A,#e6b91b); color:#3a2a00;
}
:root[data-theme="light"] .btn.danger{
  background: linear-gradient(180deg,var(--danger),#a01318); color:#fff;
}
:root[data-theme="light"] .btn.ghost{
  background:#f1f4fa; color:#1d2636;
}
:root[data-theme="light"] .progress{ background:#e6e9f2; border-color:#00000022; }
:root[data-theme="light"] .timerRingBg{ stroke:#00000022; }
:root[data-theme="light"] .footer{ color:#6b7280; border-top:1px solid var(--ring); }
:root[data-theme="light"] .prize{
  background: linear-gradient(180deg, #ffffff, #f6f8fc);
  border-color:#00000033; color:var(--ink);
}
</style>
</head>
<body>

<div class="stage">
  <!-- HEADER -->
  <header class="header" role="banner">
    <div class="h-left">
      <img src="logo.png" alt="SEDCON / Procon-RJ" class="logoImg">
    </div>
    <div class="h-right">
      <!-- seletor de tema (opcional, fica oculto por CSS) -->
      <!-- <select id="themeSel" class="select" aria-label="Tema">
        <option value="default">Padrão</option>
        <option value="contrast">Alto contraste</option>
        <option value="cvd">Daltônico-safe</option>
      </select> -->
      <button id="btnTheme" class="minibtn" title="Tema claro/escuro">☀️</button>
      <button id="btnKiosk" class="minibtn" title="Kiosk mode">Kiosk</button>
      <button id="btnExport" class="minibtn" title="Exportar contatos">.txt</button>
      <button id="btnMute" class="minibtn" aria-pressed="true" title="Som">🔇</button>
      <button id="btnReset" class="minibtn danger" title="Reset">Reset</button>
    </div>
  </header>

  <!-- CONTEÚDO -->
  <main class="screen" role="main">
    <div class="kiosk" id="kiosk">
      <div class="bggrid" aria-hidden="true"></div>

      <!-- HUD -->
      <div class="hud">
        <div class="badge">Score: <span id="score" class="pixel">0000</span></div>
        <div class="timerWrap" aria-live="polite" aria-atomic="true">
          <svg class="timerSvg" viewBox="0 0 120 120" width="84" height="84" role="img" aria-label="Tempo">
            <circle class="timerRingBg" cx="60" cy="60" r="52" fill="none" stroke-width="12"></circle>
            <circle id="timerRing" class="timerRing" cx="60" cy="60" r="52" fill="none" stroke-width="12"
                    stroke-linecap="round" stroke-dasharray="326.7256" stroke-dashoffset="0"></circle>
          </svg>
          <div id="timerNum" class="timerNum pixel" style="font-size:20px">60</div>
        </div>
        <div class="badge pixel" id="lives">❤❤❤</div>
      </div>

      <!-- Corpo -->
      <div class="body">
        <div class="title pixel" id="gameTitle">Quiz do Consumidor</div>

        <!-- START -->
        <section id="start" class="center">
          <div style="margin:6px 0 10px;color:var(--muted);font-size:14px">
            Digite seus dados e toque em Iniciar
          </div>

          <div class="formGrid">
            <input id="playerName" class="input" aria-label="Nome" placeholder="Seu nome *" autocomplete="name" required>

            <!-- WhatsApp com prefixo (21) -->
            <div class="whatsRow">
              <span class="whatsPrefix">(21)</span>
              <input id="playerWhats" class="input" aria-label="WhatsApp"
                     placeholder="Seu WhatsApp *"
                     inputmode="numeric" pattern="[0-9]*" maxlength="9" required>
            </div>

            <input id="playerInsta" class="input" aria-label="Instagram" placeholder="Instagram (ex.: @usuario)" inputmode="text" autocomplete="off">
          </div>

          <div class="formRow">
            <button id="btnStart" class="btn pixel" type="button" disabled>INICIAR</button>
          </div>

          <div style="color:var(--muted);font-size:12px;margin-top:6px">
            * Somente armazenado no dispositivo para fins de contato no evento.
          </div>
        </section>

        <!-- QUIZ -->
        <section id="quiz" hidden>
          <div class="q" id="qtext">Pergunta…</div>
          <div class="progress" aria-hidden="true"><i id="bar"></i></div>
          <div class="answers" id="answers" role="list"></div>
        </section>

        <!-- RESULTADO -->
        <section id="result" hidden class="center">
          <div id="resultTitle" class="title pixel">RESULTADO</div>
          <div style="display:flex;gap:10px;justify-content:center;margin-top:6px;flex-wrap:wrap">
            <div class="badge" style="background:#001a0d">Acertos <span id="hits" class="pixel" style="margin-left:6px">0/0</span></div>
            <div class="badge" style="background:#1b0033">Score <span id="finalScore" class="pixel" style="margin-left:6px">0000</span></div>
          </div>

          <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap">
            <button id="btnAgain" class="btn alt pixel">JOGAR NOVAMENTE</button>
            <button id="btnClearBoard" class="btn danger">Limpar Ranking</button>
          </div>

          <div class="prize" style="margin:12px auto 0; width:min(640px,100%); text-align:left">
            <div style="font-weight:900;margin-bottom:6px">Ranking — Top 5 <span class="badge" style="margin-left:8px">local</span></div>
            <table id="boardTable" style="width:100%;border-collapse:collapse;font-size:14px"></table>
          </div>
        </section>
      </div>

      <!-- Rodapé interno (brinde oculto) -->
      <div class="footerBox">
        <div class="prize" id="footPrize">Brinde: —</div>
      </div>
    </div>
  </main>

  <footer class="footer">v3.2 — kiosk + light mode + WhatsApp</footer>
</div>

<script>
/* ============== Helpers ============== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const wait=ms=>new Promise(r=>setTimeout(r,ms));
const pad4=n=>String(n).padStart(4,'0');
const show=id=>['start','quiz','result'].forEach(k=>document.getElementById(k).hidden=(k!==id));

/* Safe viewport height */
function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
setVH(); addEventListener('resize', setVH);
addEventListener('orientationchange', ()=>setTimeout(setVH, 250));
document.addEventListener('visibilitychange', ()=>setTimeout(setVH, 250));

const CONFIG={N:5,TIME:60,LIVES:3,BOARD:5,KEYS:{BOARD:'procon_board',THEME:'procon_theme',CONTACTS:'procon_contacts'}};
const CIRC=326.7256;

/* ============== Tema claro/escuro (high-ambient) ============== */
const THEME_KEY = CONFIG.KEYS.THEME || 'procon_theme';
function setTheme(theme){ // 'light' | 'dark' | 'auto'
  if(theme === 'auto'){
    const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
    document.documentElement.setAttribute('data-theme', prefersLight ? 'light' : 'dark');
  }else{
    document.documentElement.setAttribute('data-theme', theme);
  }
  localStorage.setItem(THEME_KEY, theme);
  const t = document.documentElement.getAttribute('data-theme');
  const btn = document.getElementById('btnTheme');
  if(btn) btn.textContent = (t === 'light') ? '🌙' : '☀️';
}
(function initTheme(){
  const url = new URL(location.href);
  const qp = (url.searchParams.get('theme')||'').toLowerCase(); // light | dark | auto
  const saved = (localStorage.getItem(THEME_KEY)||'').toLowerCase();
  const start = qp || saved || 'auto';
  setTheme(start);
  if(start==='auto' && window.matchMedia){
    window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', ()=>setTheme('auto'));
  }
})();
document.getElementById('btnTheme')?.addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  const next = (cur==='light') ? 'dark' : 'light';
  setTheme(next);
});

/* Áudio */
let audioCtx=null;
const S={name:'Jogador',whats:'',insta:'',pool:[],idx:0,ok:0,lives:CONFIG.LIVES,score:0,time:CONFIG.TIME,lock:false,tick:null,muted:true};
function ensureAudio(){ if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} } }
function blip(type,f,d,v){ if(!audioCtx||S.muted) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.value=f; g.gain.value=v; o.connect(g); g.connect(audioCtx.destination);
  o.start(); setTimeout(()=>{try{o.stop()}catch{}}, Math.max(60,d*1000));
}
const sfx={
  start(){[523,659,784].forEach((f,i)=>setTimeout(()=>blip('square',f,.09,.25),i*110));},
  ok(){blip('square',880,.09,.28)}, bad(){blip('sawtooth',160,.14,.28)},
  win(){[659,784,988,1174].forEach((f,i)=>setTimeout(()=>blip('square',f,.09,.3),i*120));},
  over(){[392,330,262].forEach((f,i)=>setTimeout(()=>blip('triangle',f,.12,.3),i*150));}
};

/* Banco de perguntas — 22 itens no total; o jogo sorteia 5 por partida */
const BANK = [
  { q:'Comprou pela internet e se arrependeu. Pode devolver?', a:['Não','Sim, em até 7 dias','Só se tiver defeito','Apenas com aval do vendedor'], c:1, tip:'Direito de arrependimento (7 dias).' },
  { q:'Cobrança indevida paga: seu direito é…', a:['Nada','Devolver o valor','Devolução em dobro','Voucher'], c:2, tip:'Repetição do indébito em dobro.' },
  { q:'Produto entregue diferente do contratado:', a:['Aceitar a variação','Exigir o contratado ou cancelar','Pedir 10% de desconto','Aguardar 30 dias'], c:1, tip:'Entrega deve corresponder.' },
  { q:'Recebeu produto não solicitado com boleto:', a:['Não pagar (é amostra grátis)','Pagar','Só se abrir a caixa','Guardar e pagar depois'], c:0, tip:'Envio sem pedido é proibido.' },
  { q:'Preço menor na gôndola vs caixa:', a:['Vale o do caixa','Vale o menor preço','Divide ao meio','Nenhum'], c:1, tip:'Prevalece o menor preço.' },
  { q:'Quem é consumidor pelo CDC?', a:['Apenas pessoa física','Pessoa física ou jurídica','Somente quem compra on-line','Apenas empresas'], c:1, tip:'Art. 2º: destinatário final.' },
  { q:'Garantia legal para duráveis é de…', a:['30 dias','90 dias','6 meses','1 ano'], c:1, tip:'CDC art. 26 — 90 dias.' },

  { q:'Compra em loja física e se arrependeu. Pode trocar?', a:['Sim, em até 7 dias','A loja não é obrigada; só se tiver defeito','Somente com nota carimbada','Apenas nos fins de semana'], c:1, tip:'Troca só por política da loja; defeito é obrigatório.' },
  { q:'Entrega atrasou além do combinado:', a:['Aguardar indefinidamente','Pagar multa','Pode cancelar e receber reembolso ou exigir entrega','Ir ao Procon antes de falar com a loja'], c:2, tip:'Descumprimento de oferta: pode cancelar ou exigir cumprimento.' },
  { q:'Defeito não solucionado em 30 dias (produto durável):', a:['Aguardar mais 30 dias','Aceitar crédito na loja','Escolher: troca, abatimento ou devolução do valor','Apenas assistência técnica'], c:2, tip:'Art. 18: consumidor escolhe a solução.' },
  { q:'Oferta/publicidade descumprida:', a:['Aceitar produto diferente','Exigir cumprimento da oferta ou desfazer a compra','Pedir 10% de desconto','Nada a fazer'], c:1, tip:'Oferta vincula o fornecedor.' },
  { q:'Exigem comprar “garantia estendida” para vender o produto:', a:['É venda casada; pode recusar','Obrigatório por lei','Só em promoções','Apenas sem nota fiscal'], c:0, tip:'Venda casada é prática abusiva.' },

  /* novas 10 */
  { q:'Prazo para reclamar de vício em produto NÃO durável:', a:['7 dias','30 dias','90 dias','1 ano'], c:1, tip:'CDC art. 26: 30 dias (não duráveis).' },
  { q:'O direito de arrependimento (7 dias) vale para…', a:['Apenas loja física','Compras fora do estabelecimento (internet/telefone)','Somente produtos importados','Somente se a loja oferecer'], c:1, tip:'Compras fora do estabelecimento: 7 dias.' },
  { q:'Bar ou boate exige “consumo mínimo” para entrar. Isso é…', a:['Permitido se avisar','Venda casada e prática abusiva','Permitido só até R$ 50','Obrigatório por lei'], c:1, tip:'“Consumo mínimo” é prática abusiva.' },
  { q:'Perdeu a comanda e querem cobrar valor cheio da casa. Pode?', a:['Sim, sempre','Não; é abusivo transferir o risco ao consumidor','Somente se assinar um termo','Apenas em dias de show'], c:1, tip:'O fornecedor responde pelo controle.' },
  { q:'Furto ou dano em estacionamento conveniado (“não nos responsabilizamos”).', a:['Não responde se houver placa','Responde objetivamente pelos danos','Só responde com seguro do cliente','Depende do valor do carro'], c:1, tip:'Responsabilidade objetiva do fornecedor.' },
  { q:'Garantia contratual oferecida pela loja:', a:['Substitui a garantia legal','É adicional à garantia legal e deve ser por escrito','Só vale com carimbo','Só cobre a embalagem'], c:1, tip:'Contratual soma à legal; deve ser escrita.' },
  { q:'Preços diferentes para dinheiro e cartão:', a:['Proibido sempre','Permitido com informação prévia','Só em promoções','Apenas para débito'], c:1, tip:'Pode diferenciar se houver informação clara.' },
  { q:'Assistência técnica e orçamento:', a:['Pode consertar sem orçamento','Deve apresentar orçamento prévio; diagnóstico só se informado','Orçamento é opcional','Pode cobrar qualquer valor depois'], c:1, tip:'CDC art. 40: orçamento prévio e transparente.' },
  { q:'Produto sem manual em português ou informações claras:', a:['Tudo bem se tiver QR code','Obrigatório manual/rotulagem em português','Só se for eletrônico','Apenas se custar mais de R$500'], c:1, tip:'Direito à informação adequada e clara.' },
  { q:'Peças de reposição após fim da fabricação:', a:['Loja não precisa manter','Fornecedor deve assegurar oferta por período razoável','Só a assistência oficial mantém','Apenas enquanto durar a garantia'], c:1, tip:'CDC art. 32: deve manter peças por tempo razoável.' }
];

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function pick(n){
  const arr=shuffle(BANK.slice());
  return arr.slice(0,n).map(it=>{
    const map=it.a.map((t,i)=>({t,i})); shuffle(map);
    return {q:it.q, a:map.map(m=>m.t), c:map.findIndex(m=>m.i===it.c), tip:it.tip};
  });
}

/* ---- Kiosk Mode ---- */
const KM_KEY = 'procon_kiosk_mode';
function applyKiosk(on){
  document.documentElement.classList.toggle('kiosk-on', !!on);
  // força tema claro no totem para reduzir reflexo
  if(on){ setTheme('light'); }
  setVH();
}
const savedKM = localStorage.getItem(KM_KEY) === '1';
applyKiosk(savedKM);
document.getElementById('btnKiosk').addEventListener('click', ()=>{
  const on = !document.documentElement.classList.contains('kiosk-on');
  applyKiosk(on);
  localStorage.setItem(KM_KEY, on ? '1' : '0');
});

/* Timer */
function updateTimer(reset){
  const r=$('#timerRing'), n=$('#timerNum');
  if(reset){ r.style.strokeDashoffset='0'; r.style.stroke='var(--accent)'; n.textContent=S.time; return; }
  const p=Math.max(0,S.time/CONFIG.TIME);
  r.style.strokeDashoffset=String((1-p)*CIRC);
  r.style.stroke = (S.time<=10)?'#E5242A':'var(--accent)';
  n.textContent=S.time;
}

/* Splash/Toast */
async function splash(text='START'){ const d=document.createElement('div'); d.className='splash'; d.textContent=text; document.body.appendChild(d); await wait(700); d.remove(); }
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),1400); }

/* Contatos */
function loadContacts(){ try{return JSON.parse(localStorage.getItem(CONFIG.KEYS.CONTACTS)||'[]')}catch{return[]} }
function saveContacts(list){ localStorage.setItem(CONFIG.KEYS.CONTACTS, JSON.stringify(list)); }
function addContact(c){ const list=loadContacts(); list.push({...c, id: Math.random().toString(36).slice(2), ts: Date.now()}); saveContacts(list); }

/* Normalização do WhatsApp (apenas dígitos, garante DDD 21) */
function normalizeWhats(s){
  const digits=(s||'').replace(/\D+/g,'').slice(0,9); // até 9 dígitos do número
  return '21' + digits.padEnd(9,''); // salva como 21xxxxxxxxx (11 dígitos no total)
}
function prettyWhats(s){
  // formato (21) 9xxxx-xxxx se houver 9 dígitos após o DDD
  const d=normalizeWhats(s);
  const n=d.slice(2);
  if(n.length<9) return `(21) ${n}`;
  return `(21) ${n[0]}${n.slice(1,5)}-${n.slice(5,9)}`;
}

/* Exportar contatos (.txt) */
async function exportContactsTxt(){
  const list=loadContacts();
  if(!list.length){ toast('Nenhum contato salvo ainda.'); return; }
  const header='nome\twhats\tinstagram\tquando\n';
  const rows=list.map(r=>`${(r.name||'').trim()}\t${(r.whats||'').trim()}\t${(r.insta||'').trim()}\t${new Date(r.ts).toLocaleString()}`).join('\n');
  const blob=new Blob([header+rows+'\n'],{type:'text/plain;charset=utf-8'});
  const stamp=new Date().toISOString().slice(0,10);
  const fname=`contatos-${stamp}.txt`;

  if(window.showSaveFilePicker){
    try{
      const handle=await showSaveFilePicker({suggestedName:fname, types:[{description:'Texto', accept:{'text/plain':['.txt']}}]});
      const w=await handle.createWritable(); await w.write(blob); await w.close(); toast('Arquivo salvo ✅');
      return;
    }catch(e){ /* cancelado; fallback abaixo */ }
  }
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();}, 800);
}

/* Fluxo do jogo */
async function reset(){
  S.pool=pick(CONFIG.N);
  S.idx=0; S.ok=0;
  S.lives=CONFIG.LIVES;
  S.score=0;
  S.time=CONFIG.TIME;
  S.lock=false;
  $('#score').textContent='0000';
  $('#lives').textContent='❤'.repeat(S.lives);
  $('#bar').style.width='0%';
  updateTimer(true);
}
async function start(){
  const name=($('#playerName').value||'').trim();
  const whatsRaw=($('#playerWhats').value||'').trim();
  let insta=($('#playerInsta').value||'').trim();
  if(insta && !insta.startsWith('@')) insta='@'+insta.replace(/^@+/,'');

  S.name = name || 'Jogador';
  S.whats = normalizeWhats(whatsRaw);
  S.insta = insta;

  addContact({name:S.name, whats:S.whats, insta:S.insta});

  await splash('START!'); ensureAudio(); try{audioCtx?.resume?.()}catch{}; sfx.start();
  await reset(); show('quiz'); nextQ();
  clearInterval(S.tick);
  S.tick=setInterval(()=>{ S.time--; updateTimer(); if(S.time<=0){ clearInterval(S.tick); over(); } },1000);
}

function nextQ(){
  if(S.idx>=S.pool.length){ return win(); }
  const it=S.pool[S.idx];
  $('#qtext').textContent=`Q${S.idx+1}/${S.pool.length}: ${it.q}`;
  const wrap=$('#answers'); wrap.innerHTML='';
  it.a.forEach((txt,i)=>{
    const b=document.createElement('button');
    b.className='answer';
    b.innerHTML=`<span class="key">${String.fromCharCode(65+i)}</span><span>${txt}</span>`;
    b.addEventListener('click',()=>choose(i,b,it));
    wrap.appendChild(b);
  });
  $('#bar').style.width = ((S.idx/S.pool.length)*100) + '%';
}

async function choose(i,btn,it){
  if(S.lock) return; S.lock=true;
  const ok=i===it.c;
  if(ok){ btn.classList.add('correct'); S.ok++; S.score+=250; $('#score').textContent=pad4(S.score); sfx.ok(); toast(it.tip); }
  else{ btn.classList.add('wrong'); S.lives--; $('#lives').textContent='❤'.repeat(Math.max(0,S.lives)); sfx.bad(); if(S.lives<=0){ await wait(700); return over(); } }
  $$('.answer').forEach(b=>{ if(b!==btn) b.classList.add('disabled'); });
  await wait(900); S.idx++; S.lock=false; nextQ();
}

function prizeFor(ok,total){ if(ok===total) return 'Melhor Prêmio'; if(ok>=Math.ceil(total/2)) return 'Prêmio Médio'; if(ok===0) return 'CDC comentado'; return '—'; }
function uuid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function finish(title){
  const total=S.pool.length;
  const entry={ id:uuid(), name:S.name||'Jogador', correct:S.ok, total, score:S.score, time:Math.max(0,S.time), prize:prizeFor(S.ok,total), ts:Date.now() };
  const board=addBoard(entry);
  $('#resultTitle').textContent=`${title}, ${S.name || 'Jogador'}! 🎉`;
  $('#hits').textContent=`${S.ok}/${total}`; $('#finalScore').textContent=pad4(S.score);
  renderBoard('#boardTable',board);
  show('result');
}
function win(){ clearInterval(S.tick); sfx.win(); splash('WIN!').then(()=>finish('PARABÉNS')); }
function over(){ clearInterval(S.tick); sfx.over(); splash('FIM DE JOGO').then(()=>finish('FIM DE JOGO')); }

/* Leaderboard */
function loadBoard(){ try{return JSON.parse(localStorage.getItem(CONFIG.KEYS.BOARD)||'[]')}catch{return[]} }
function saveBoard(list){ localStorage.setItem(CONFIG.KEYS.BOARD, JSON.stringify(list)); }
function addBoard(entry){ const list=loadBoard(); list.push(entry); list.sort((a,b)=>(b.score-a.score)||(b.time-a.time)); const top=list.slice(0,CONFIG.BOARD); saveBoard(top); return top; }
function renderBoard(sel,list=loadBoard()){
  const t=$(sel); if(!t) return;
  if(!list.length){ t.innerHTML='<tr><td style="padding:6px 0">Sem resultados ainda.</td></tr>'; return; }
  let rows='<tr><th style="text-align:left;padding:6px 4px">#</th><th style="text-align:left">Nome</th><th>Acertos</th><th>Score</th><th>Tempo</th><th>Quando</th></tr>';
  rows+=list.map((r,i)=>`<tr>
    <td style="padding:6px 4px">${i+1}</td>
    <td>${(r.name||'').replace(/[&<>"']/g,'')}</td>
    <td style="text-align:center">${r.correct}/${r.total}</td>
    <td style="text-align:center">${pad4(r.score)}</td>
    <td style="text-align:center">${r.time}s</td>
    <td>${new Date(r.ts).toLocaleString()}</td>
  </tr>`).join('');
  t.innerHTML=rows;
}

/* Validação */
const nameInput=$('#playerName'), whatsInput=$('#playerWhats'), instaInput=$('#playerInsta');
function validWhats(s){
  // exige ao menos 8 dígitos (do móvel) — ideal: 9 dígitos no RJ
  const d=(s||'').replace(/\D+/g,'');
  return d.length>=8;
}
function validateForm(){
  const name=(nameInput.value||'').trim();
  const phone=(whatsInput.value||'').trim();
  $('#btnStart').disabled = !(name.length>1 && validWhats(phone));
}
[nameInput,whatsInput,instaInput].forEach(el=>el.addEventListener('input', validateForm));

/* Controles principais */
$('#btnStart').addEventListener('click', e=>{ e.preventDefault(); start(); });
$('#btnAgain').addEventListener('click', e=>{
  e.preventDefault();
  clearInterval(S.tick);
  S.time=CONFIG.TIME; updateTimer(true);
  $('#score').textContent='0000';
  $('#lives').textContent='❤'.repeat(CONFIG.LIVES);
  nameInput.value=''; whatsInput.value=''; instaInput.value='';
  S.name='Jogador'; S.whats=''; S.insta='';
  $('#btnStart').disabled=true;
  show('start');
});
$('#btnReset').addEventListener('click', ()=>{
  clearInterval(S.tick); show('start');
  nameInput.value=''; whatsInput.value=''; instaInput.value='';
  $('#btnStart').disabled=true; S.name='Jogador'; S.whats=''; S.insta='';
  $('#score').textContent='0000'; $('#lives').textContent='❤❤❤';
  updateTimer(true);
  renderBoard('#boardTable');
});
$('#btnClearBoard').addEventListener('click', ()=>{ if(confirm('Limpar ranking local?')){ localStorage.setItem(CONFIG.KEYS.BOARD,'[]'); renderBoard('#boardTable'); }});
$('#btnMute').addEventListener('click',()=>{ S.muted=!S.muted; $('#btnMute').textContent=S.muted?'🔇':'🔊'; $('#btnMute').setAttribute('aria-pressed', String(!S.muted)); });
$('#btnExport').addEventListener('click', exportContactsTxt);

/* Temas antigos (compat, mas não usados) */
const themeSel=$('#themeSel');
function applyThemeOld(val){
  if(val==='contrast'){
    const r=document.documentElement.style;
    r.setProperty('--bg','#000'); r.setProperty('--panel','#000'); r.setProperty('--ink','#fff'); r.setProperty('--muted','#ddd');
    r.setProperty('--brand','#00ff66'); r.setProperty('--accent','#ffff00'); r.setProperty('--ans','#111');
    r.setProperty('--ans-ok','#005a22'); r.setProperty('--ans-bad','#4d0010');
  }else if(val==='cvd'){
    const r=document.documentElement.style;
    r.setProperty('--bg','#09111e'); r.setProperty('--panel','#0d1430cc'); r.setProperty('--ink','#f3f6ff'); r.setProperty('--muted','#c7cfe6');
    r.setProperty('--brand','#2aa6f2'); r.setProperty('--accent','#ffd166'); r.setProperty('--ans','#1a234d');
    r.setProperty('--ans-ok','#1c4f7a'); r.setProperty('--ans-bad','#6b2f4a');
  }else{
    document.documentElement.removeAttribute('style');
  }
  localStorage.setItem(CONFIG.KEYS.THEME,val);
}
themeSel?.addEventListener('change', e=>applyThemeOld(e.target.value));
(function boot(){
  renderBoard('#boardTable'); updateTimer(true); validateForm();
})();
</script>
</body>
</html>

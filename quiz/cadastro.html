<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Quiz do Consumidor — mobile test</title>
<meta name="theme-color" content="#24A653" />

<!-- Google tag (gtag.js) — GA4 (não enviar PII) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-05H6KL6ZF1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-05H6KL6ZF1'); // NÃO enviar PII
</script>

<style>
:root{
  --brand:#24A653; --brand-hi:#8ff5c1;
  --accent:#FFDA3A; --danger:#E5242A;
  --bg:#0b0b16; --panel:#0f1330cc; --ink:#ecf2ff; --muted:#a9b7d7;
  --ans:#19214a; --ans-ok:#0f6a2f; --ans-bad:#7a1f2e;
  --ring:#ffffff24; --radius:16px; --gap:12px; --vh:1vh;
  color-scheme: dark;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;max-width:100vw}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif;overflow-x:hidden;overflow-y:auto}

/* Palco */
.stage{
  min-height: calc(var(--vh) * 100);
  width:100%;
  display:flex; flex-direction:column;
  background:
    radial-gradient(900px 700px at 80% -10%, #17224b 0%, transparent 60%),
    radial-gradient(600px 600px at 15% 10%, #111a3d 0%, transparent 60%),
    var(--bg);
}

/* Header compacto */
.header{
  height:56px; display:flex; align-items:center; justify-content:space-between;
  padding: 0 10px;
  background: linear-gradient(180deg,#0e1436aa,#0b102c99);
  border-bottom:1px solid var(--ring); backdrop-filter: blur(6px);
  position:sticky; top:0; z-index:10; gap:8px;
}
.h-left{display:flex; align-items:center; gap:8px; min-width:0; flex:1 1 auto}
.h-right{display:flex; align-items:center; gap:6px; flex:0 0 auto}

/* Logos: escura e clara */
.logoImg{ height:80px; width:auto; display:block; image-rendering:-webkit-optimize-contrast; }
.logo-light { display:none; }
@media (min-width:420px){ .logoImg{ height:44px } }

/* No modo claro, troca a logo */
:root[data-theme="light"] .logo-dark { display:none; }
:root[data-theme="light"] .logo-light{ display:block; }

/* Controles */
.minibtn{
  height:34px; padding:0 10px; font-weight:800; font-size:12px;
  border:3px solid #000; border-radius:10px; box-shadow:0 4px 0 #000;
  cursor:pointer; background:#1a204a; color:#fff; line-height:30px;
}
.minibtn.danger{background:linear-gradient(180deg,var(--danger),#8b1017)}
.select{
  appearance:none; background:#0d1130; color:#fff;
  border:3px solid #000; border-radius:10px; height:30px; font-weight:800; font-size:11px;
  padding:0 6px; max-width:36vw; text-overflow:ellipsis;
}
@media (max-width:380px){ .select{ max-width:30vw; font-size:10px; padding:0 5px } }

/* Conteúdo */
.screen{display:grid;place-items:start;padding:12px}
.kiosk{
  width:min(720px, 100%);
  margin: 10px auto 16px;
  background: linear-gradient(180deg, var(--panel), #0f1338e0);
  border:4px solid #000;border-radius:var(--radius);
  box-shadow:0 14px 40px rgba(0,0,0,.45);
  position:relative; overflow:visible;
}
.bggrid{position:absolute; inset:0; opacity:.22; pointer-events:none;
  background:
    linear-gradient(transparent 95%, rgba(255,255,255,.06) 95%) 0 0/100% 28px,
    linear-gradient(90deg, transparent 95%, rgba(255,255,255,.06) 95%) 0 0/28px 100%;
  border-radius:inherit;
}

/* HUD */
.hud{display:flex; justify-content:center; align-items:center; gap:12px; padding:12px 10px 2px}
.timerWrap{position:relative;width:84px;height:84px;display:grid;place-items:center}
.timerSvg{transform:rotate(-90deg)} .timerRingBg{stroke:#000;opacity:.5}
.timerRing{stroke:var(--accent);transition:stroke-dashoffset .25s linear}
.timerNum{position:absolute;font-weight:900;font-size:20px}
.badge{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;background:#0d1130;border:3px solid #000;border-radius:12px;box-shadow:inset 0 -4px 0 rgba(0,0,0,.45),0 4px 0 #000;font-weight:900;font-size:14px}

/* Corpo */
.body{display:grid; gap:12px; padding:12px}
.title{font-weight:900; font-size: clamp(20px, 3.4vh, 28px); color:var(--accent); text-align:center; text-shadow: 0 3px 0 #000, 0 0 12px rgba(255,218,58,.3)}
.q{font-weight:800; font-size: clamp(18px, 2.6vh, 22px); text-align:center; text-shadow:0 2px 0 #000}
.answers{display:grid; grid-template-columns:1fr; gap:12px; align-content:start}
.answer{
  display:flex; align-items:center; gap:12px; min-height:64px;
  padding:14px; text-align:left; background:var(--ans); color:#fff;
  border:4px solid #000; border-radius:14px; box-shadow:0 8px 0 #000;
  font-weight:800; font-size:16px; cursor:pointer; user-select:none; touch-action: manipulation;
}
.answer:active{transform:translateY(3px)}
.key{display:grid;place-items:center;width:36px;height:36px;min-width:36px;border:3px solid #333;border-radius:10px;background:#000;color:var(--accent);font-weight:900}
.answer.correct{background:var(--ans-ok)}
.answer.wrong{background:var(--ans-bad)}
.answer.disabled{opacity:.6; pointer-events:none}

/* Progresso */
.progress{width:88%; height:10px; margin:6px auto 2px; background:#000; border:4px solid #000; border-radius:9px; overflow:hidden}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand-hi));width:0%}

/* Rodapé interno / “Brinde” oculto */
.footerBox{display:flex;justify-content:center;align-items:center;gap:10px;padding:12px}
.prize{padding:8px 10px;border:3px dashed #000;border-radius:12px;background: linear-gradient(180deg, #16205b, #0e1541); font-weight:900; font-size:14px}
#prizeBox, #footPrize { display:none; } /* ocultar “Brinde” */

/* Botões */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;
  background:linear-gradient(180deg,var(--brand),color-mix(in oklab,var(--brand) 70%, #000));
  color:#021;padding:14px 18px;border:4px solid #000;border-radius:14px;
  font-weight:900;font-size:16px; box-shadow:0 8px 0 #000; cursor:pointer; min-height:52px;
}
.btn.alt{background:linear-gradient(180deg,var(--accent),#b48a1d); color:#311}
.btn.danger{background:linear-gradient(180deg,var(--danger),#8b1017); color:#fff}
.btn.ghost{background:#0d1130; color:#fff}
.btn:active{transform:translateY(3px); box-shadow:0 5px 0 #000}

/* Inputs */
.input{
  width:100%; padding:14px 16px; border:4px solid #000; border-radius:12px;
  background:#0d1130; color:#fff; font-weight:800; font-size:16px;
  box-shadow:inset 0 -4px 0 rgba(0,0,0,.45),0 4px 0 #000;
}
.input::placeholder{color:#8892b0}
.formGrid{display:grid; grid-template-columns:1fr; gap:10px; margin-bottom:8px}

/* WhatsApp prefixo */
.whatsRow{display:flex;align-items:center;gap:6px}
.whatsPrefix{font-weight:900;font-size:16px;color:var(--muted);background:#0d1130;border:4px solid #000;border-radius:12px;padding:0 10px;height:52px;display:grid;place-items:center}

/* Linha de ações: centraliza INICIAR */
.formRow{ display:grid; grid-template-columns:1fr; gap:10px; justify-items:center; }
.formRow .btn#btnStart{ width:min(260px, 70%); }

/* Footer global */
.footer{display:flex;justify-content:center;align-items:center;height:40px;border-top:1px solid var(--ring);color:var(--muted);font-size:12px}

/* esconde o seletor de tema padrão (mantido no HTML se quiser reativar) */
.select{ display:none; }

/* ---------- KIOSK MODE (totem vertical 43") ---------- */
html.kiosk-on .logoImg{ height:52px; }
html.kiosk-on .kiosk{
  width:min(980px, 96vw);
  min-height: calc(var(--vh) * 0.92);
}
html.kiosk-on .title{ font-size: clamp(26px, 3.8vh, 40px); }
html.kiosk-on .q{     font-size: clamp(22px, 3.0vh, 30px); }
html.kiosk-on .input,
html.kiosk-on .btn,
html.kiosk-on .answer{ font-size: clamp(18px, 2.2vh, 22px); }
html.kiosk-on .answer{ min-height: 72px; }
html.kiosk-on .btn{   min-height: 60px; }
html.kiosk-on .timerWrap{ width:100px; height:100px; }
html.kiosk-on .hud{ padding-top:16px; }
html.kiosk-on .body{ gap: clamp(12px, 2vh, 22px); }
html.kiosk-on .footer{ margin-top: 6px; }

/* ===================== MODO CLARO (High-Ambient) ===================== */
:root[data-theme="light"]{
  --bg:#f7f9fc;
  --panel:#ffffffcc;
  --ink:#0e1320;
  --muted:#5a6478;
  --ring:#00000018;

  --brand:#24A653; --brand-hi:#0bbd64;
  --accent:#C28B00;
  --danger:#C81E24;

  --ans:#eef2f9;
  --ans-ok:#e6f7ed;
  --ans-bad:#fdecef;

  color-scheme: light;
}
:root[data-theme="light"] .stage{
  background:
    radial-gradient(900px 700px at 80% -10%, #ffffff 0%, transparent 60%),
    radial-gradient(600px 600px at 15% 10%, #ffffff 0%, transparent 60%),
    var(--bg);
}
:root[data-theme="light"] .kiosk{
  background: linear-gradient(180deg, var(--panel), #ffffffee);
  border-color:#1e2a3a20;
  box-shadow:0 8px 28px rgba(0,0,0,.12);
}
:root[data-theme="light"] .header{
  background: linear-gradient(180deg,#ffffffd9,#ffffffc2);
  border-bottom:1px solid var(--ring);
  backdrop-filter:saturate(1.2) blur(8px);
}
:root[data-theme="light"] .title{ color:#C28B00; text-shadow:none; }
:root[data-theme="light"] .q{ text-shadow:none; color:var(--ink); }
:root[data-theme="light"] .badge{
  background:#f1f4fa; border-color:#00000022;
  box-shadow:inset 0 -3px 0 #00000010, 0 3px 0 #00000022;
  color:var(--ink);
}
:root[data-theme="light"] .input{
  background:#ffffff; color:var(--ink);
  border-color:#00000022;
  box-shadow:inset 0 -3px 0 #00000010, 0 3px 0 #00000022;
}
:root[data-theme="light"] .whatsPrefix{ background:#ffffff; border-color:#00000022; }
:root[data-theme="light"] .minibtn{
  background:#ffffff; color:#1d2636;
  border-color:#00000022; box-shadow:0 3px 0 #00000022;
}
:root[data-theme="light"] .answer{
  background:var(--ans); color:#0e1320;
  border-color:#00000022; box-shadow:0 6px 0 #00000022;
}
:root[data-theme="light"] .answer.correct{ background:var(--ans-ok); }
:root[data-theme="light"] .answer.wrong{   background:var(--ans-bad); }
:root[data-theme="light"] .key{
  background:#ffffff; color:#C28B00; border-color:#00000022;
}
:root[data-theme="light"] .btn{
  color:#042; border-color:#00000022; box-shadow:0 6px 0 #00000022;
}
:root[data-theme="light"] .btn.alt{
  background: linear-gradient(180deg,#FFDA3A,#e6b91b); color:#3a2a00;
}
:root[data-theme="light"] .btn.danger{
  background: linear-gradient(180deg,var(--danger),#a01318); color:#fff;
}
:root[data-theme="light"] .btn.ghost{
  background:#f1f4fa; color:#1d2636;
}
:root[data-theme="light"] .progress{ background:#e6e9f2; border-color:#00000022; }
:root[data-theme="light"] .timerRingBg{ stroke:#00000022; }
:root[data-theme="light"] .footer{ color:#6b7280; border-top:1px solid var(--ring); }
:root[data-theme="light"] .prize{
  background: linear-gradient(180deg, #ffffff, #f6f8fc);
  border-color:#00000033; color:var(--ink);
}
</style>
</head>
<body>

<div class="stage">
  <!-- HEADER -->
  <header class="header" role="banner">
    <div class="h-left">
      <!-- duas logos: escura e clara -->
      <img src="/quiz/logo.png" alt="SEDCON / Procon-RJ" class="logoImg logo-dark">
      <img src="/quiz/logoescura.png" alt="SEDCON / Procon-RJ" class="logoImg logo-light">
    </div>
    <div class="h-right">
      <button id="btnTheme" class="minibtn" title="Tema claro/escuro">☀️</button>
      <button id="btnKiosk" class="minibtn" title="Kiosk mode">Kiosk</button>
      <button id="btnExport" class="minibtn" title="Exportar contatos">.txt</button>
      <button id="btnMute" class="minibtn" aria-pressed="true" title="Som">🔇</button>
      <button id="btnReset" class="minibtn danger" title="Reset">Reset</button>
    </div>
  </header>

  <!-- CONTEÚDO -->
  <main class="screen" role="main">
    <div class="kiosk" id="kiosk">
      <div class="bggrid" aria-hidden="true"></div>

      <!-- HUD -->
      <div class="hud">
        <div class="badge">Score: <span id="score" class="pixel">0000</span></div>
        <div class="timerWrap" aria-live="polite" aria-atomic="true">
          <svg class="timerSvg" viewBox="0 0 120 120" width="84" height="84" role="img" aria-label="Tempo">
            <circle class="timerRingBg" cx="60" cy="60" r="52" fill="none" stroke-width="12"></circle>
            <circle id="timerRing" class="timerRing" cx="60" cy="60" r="52" fill="none" stroke-width="12"
                    stroke-linecap="round" stroke-dasharray="326.7256" stroke-dashoffset="0"></circle>
          </svg>
          <div id="timerNum" class="timerNum pixel" style="font-size:20px">60</div>
        </div>
        <div class="badge pixel" id="lives">❤❤❤</div>
      </div>

      <!-- Corpo -->
      <div class="body">
        <div class="title pixel" id="gameTitle">Quiz do Consumidor</div>

        <!-- START -->
        <section id="start" class="center">
          <div style="margin:6px 0 10px;color:var(--muted);font-size:14px">
            Digite seus dados e toque em Iniciar
          </div>

          <div class="formGrid">
            <input id="playerName" class="input" aria-label="Nome" placeholder="Seu nome *" autocomplete="name" required>

            <!-- WhatsApp com prefixo (21) -->
            <div class="whatsRow">
              <span class="whatsPrefix">(21)</span>
              <input id="playerWhats" class="input" aria-label="WhatsApp"
                     placeholder="Seu WhatsApp *"
                     inputmode="numeric" pattern="[0-9]*" maxlength="9" required>
            </div>

            <input id="playerInsta" class="input" aria-label="Instagram" placeholder="Instagram (ex.: @usuario)" inputmode="text" autocomplete="off">
          </div>

          <div class="formRow">
            <button id="btnStart" class="btn pixel" type="button" disabled>INICIAR</button>
          </div>

          <div style="color:var(--muted);font-size:12px;margin-top:6px">
            * Somente armazenado no dispositivo para fins de contato no evento.
          </div>
        </section>

        <!-- QUIZ -->
        <section id="quiz" hidden>
          <div class="q" id="qtext">Pergunta…</div>
          <div class="progress" aria-hidden="true"><i id="bar"></i></div>
          <div class="answers" id="answers" role="list"></div>
        </section>

        <!-- RESULTADO -->
        <section id="result" hidden class="center">
          <div id="resultTitle" class="title pixel">RESULTADO</div>
          <div style="display:flex;gap:10px;justify-content:center;margin-top:6px;flex-wrap:wrap">
            <div class="badge" style="background:#001a0d">Acertos <span id="hits" class="pixel" style="margin-left:6px">0/0</span></div>
            <div class="badge" style="background:#1b0033">Score <span id="finalScore" class="pixel" style="margin-left:6px">0000</span></div>
          </div>

          <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap">
            <button id="btnAgain" class="btn alt pixel">JOGAR NOVAMENTE</button>
            <button id="btnClearBoard" class="btn danger">Limpar Ranking</button>
          </div>

          <div class="prize" style="margin:12px auto 0; width:min(640px,100%); text-align:left">
            <div style="font-weight:900;margin-bottom:6px">Ranking — Top 5 <span class="badge" style="margin-left:8px">local</span></div>
            <table id="boardTable" style="width:100%;border-collapse:collapse;font-size:14px"></table>
          </div>
        </section>
      </div>

      <!-- Rodapé interno (brinde oculto) -->
      <div class="footerBox">
        <div class="prize" id="footPrize">Brinde: —</div>
      </div>
    </div>
  </main>

  <footer class="footer">v3.4 — GA4 + Google Forms + Light Logo</footer>
</div>

<!-- ===== Envio para Google Forms (oculto) ===== -->
<iframe name="gf_target" style="display:none"></iframe>
<form id="gf" action="https://docs.google.com/forms/d/e/1FAIpQLSfiE4TLU73_PadOI-hLeCT-RzQoIG19Yxx4ZurlBIQeyNBmxA/formResponse"
      method="POST" target="gf_target" style="display:none">
  <!-- Nome -->
  <input type="hidden" name="entry.376918714" id="gf_name">
  <!-- Telefone (11 dígitos, ex: 21 + 9xxxxxxx) -->
  <input type="hidden" name="entry.1749651697" id="gf_phone">
  <!-- Futuro: Instagram/score/etc — crie no Forms e adicione aqui -->
</form>

<script>
/* ============== Helpers ============== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const wait=ms=>new Promise(r=>setTimeout(r,ms));
const pad4=n=>String(n).padStart(4,'0');
const show=id=>['start','quiz','result'].forEach(k=>document.getElementById(k).hidden=(k!==id));

/* Safe viewport height */
function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
setVH(); addEventListener('resize', setVH);
addEventListener('orientationchange', ()=>setTimeout(setVH, 250));
document.addEventListener('visibilitychange', ()=>setTimeout(setVH, 250));

const CONFIG={N:5,TIME:60,LIVES:3,BOARD:5,KEYS:{BOARD:'procon_board',THEME:'procon_theme',CONTACTS:'procon_contacts'}};
const CIRC=326.7256;

/* ===== GA4 helpers (sem PII) ===== */
const ANALYTICS_ON = typeof gtag === 'function';
const SESSION_ID = sessionStorage.getItem('session_id') || (()=> {
  const id = (crypto?.randomUUID?.() || (Date.now()+'-'+Math.random().toString(36).slice(2)));
  sessionStorage.setItem('session_id', id);
  return id;
})();
function ev(name, params={}){ if(!ANALYTICS_ON) return; gtag('event', name, { session_id: SESSION_ID, ...params }); }

/* ============== Tema claro/escuro (high-ambient) ============== */
const THEME_KEY = CONFIG.KEYS.THEME || 'procon_theme';
function setTheme(theme){ // 'light' | 'dark' | 'auto'
  if(theme === 'auto'){
    const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
    document.documentElement.setAttribute('data-theme', prefersLight ? 'light' : 'dark');
  }else{
    document.documentElement.setAttribute('data-theme', theme);
  }
  localStorage.setItem(THEME_KEY, theme);
  const t = document.documentElement.getAttribute('data-theme');
  const btn = document.getElementById('btnTheme');
  if(btn) btn.textContent = (t === 'light') ? '🌙' : '☀️';
  ev('theme_change', { theme: t });
}
(function initTheme(){
  const url = new URL(location.href);
  const qp = (url.searchParams.get('theme')||'').toLowerCase(); // light | dark | auto
  const saved = (localStorage.getItem(THEME_KEY)||'').toLowerCase();
  const start = qp || saved || 'auto';
  setTheme(start);
  if(start==='auto' && window.matchMedia){
    window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', ()=>setTheme('auto'));
  }
})();
document.getElementById('btnTheme')?.addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  const next = (cur==='light') ? 'dark' : 'light';
  setTheme(next);
});

/* Áudio */
let audioCtx=null;
const S={name:'Jogador',whats:'',insta:'',pool:[],idx:0,ok:0,lives:CONFIG.LIVES,score:0,time:CONFIG.TIME,lock:false,tick:null,muted:true};
function ensureAudio(){ if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} } }
function blip(type,f,d,v){ if(!audioCtx||S.muted) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.value=f; g.gain.value=v; o.connect(g); g.connect(audioCtx.destination);
  o.start(); setTimeout(()=>{try{o.stop()}catch{}}, Math.max(60,d*1000));
}
const sfx={
  start(){[523,659,784].forEach((f,i)=>setTimeout(()=>blip('square',f,.09,.25),i*110));},
  ok(){blip('square',880,.09,.28)}, bad(){blip('sawtooth',160,.14,.28)},
  win(){[659,784,988,1174].forEach((f,i)=>setTimeout(()=>blip('square',f,.09,.3),i*120));},
  over(){[392,330,262].forEach((f,i)=>setTimeout(()=>blip('triangle',f,.12,.3),i*150));}
};

/* Banco de perguntas — 32 itens totalmente revisados (para anti-repetição e analytics) */
const BANK = [
  { id:'Q01', q:'Fez uma compra por WhatsApp e o produto não chegou. O que fazer?', 
    a:['Esperar o vendedor responder','Registrar reclamação formal e exigir entrega ou reembolso','Aceitar outro item similar','Aguardar 30 dias úteis'], 
    c:1, tip:'Compras feitas on-line têm os mesmos direitos de entrega e reembolso do CDC.' },

  { id:'Q02', q:'A loja se recusa a emitir nota fiscal. Isso é…', 
    a:['Normal','Permitido em produtos em promoção','Irregular e deve ser denunciado','Aceitável se for pessoa física'], 
    c:2, tip:'Emitir nota fiscal é obrigação legal de quem vende.' },

  { id:'Q03', q:'Produto novo apresentou defeito no segundo dia. A loja diz que só a assistência resolve. Correto?', 
    a:['Sim, sempre assistência','Não; o consumidor pode exigir troca imediata','Apenas após 7 dias','Depende do valor do produto'], 
    c:1, tip:'Vício em curto prazo: consumidor pode exigir troca ou devolução direta.' },

  { id:'Q04', q:'Restaurante cobra “taxa de desperdício” se sobrar comida. Pode?', 
    a:['Não; prática abusiva','Sim, se avisar antes','Sim, se for buffet','Permitido aos fins de semana'], 
    c:0, tip:'Cobrar taxa por sobra de comida é abusivo.' },

  { id:'Q05', q:'Empresa diz que “não faz troca” em roupa com defeito. Está certa?', 
    a:['Sim, é política da loja','Não, deve trocar ou reparar','Depende do prazo de compra','Somente com autorização do gerente'], 
    c:1, tip:'Produto com defeito deve ser substituído, reparado ou devolvido.' },

  { id:'Q06', q:'Serviço contratado atrasou e não foi concluído. O que o consumidor pode exigir?', 
    a:['Esperar o prazo dobrar','Cancelar e receber reembolso ou exigir conclusão imediata','Pagar metade do valor','Apenas registrar reclamação'], 
    c:1, tip:'Descumprimento de prazo permite cancelamento ou execução imediata.' },

  { id:'Q07', q:'Comprei um celular e não me entregaram o carregador. Isso é…', 
    a:['Permitido','Venda casada indireta','Apenas política ambiental','Sem problema se avisar'], 
    c:1, tip:'A ausência de item essencial configura prática abusiva.' },

  { id:'Q08', q:'Uma loja anuncia “sem troco”. O consumidor é obrigado a aceitar crédito?', 
    a:['Sim, é política interna','Não; o troco é dever do fornecedor','Apenas se for valor baixo','Depende do tipo de compra'], 
    c:1, tip:'Troco é obrigação; vale só se o consumidor concordar.' },

  { id:'Q09', q:'Empresa não entrega orçamento detalhado antes do conserto. Pode?', 
    a:['Sim, se for serviço simples','Não; o orçamento prévio é obrigatório','Apenas se for barato','Depende da urgência'], 
    c:1, tip:'CDC art. 40: orçamento prévio obrigatório e transparente.' },

  { id:'Q10', q:'Um site publica avaliações falsas sobre produtos. Isso é…', 
    a:['Publicidade enganosa','Marketing aceitável','Prática leal','Permitido se for humor'], 
    c:0, tip:'Divulgar avaliações falsas induz ao erro e fere o CDC.' },

  { id:'Q11', q:'Comprei passagem aérea e a empresa mudou o horário. Tenho direito a…', 
    a:['Nada, é normal','Reembolso integral ou remarcação sem custo','Apenas voucher','Esperar novo horário'], 
    c:1, tip:'Alteração de voo dá direito a reembolso total ou remarcação gratuita.' },

  { id:'Q12', q:'O prazo para reclamar de defeito em produto não durável é…', 
    a:['7 dias','30 dias','90 dias','1 ano'], 
    c:1, tip:'CDC art. 26: 30 dias para produtos não duráveis.' },

  { id:'Q13', q:'Cartão de crédito cobrou anuidade sem aviso. O que fazer?', 
    a:['Aceitar cobrança','Contestar e exigir devolução','Cancelar o cartão sem contestar','Nada, é padrão'], 
    c:1, tip:'Cobranças não informadas previamente podem ser contestadas e devolvidas.' },

  { id:'Q14', q:'Aplicativo vendeu produto com defeito. Quem responde?', 
    a:['Somente o vendedor','O app e o vendedor solidariamente','Nenhum','Apenas se for produto importado'], 
    c:1, tip:'Responsabilidade solidária entre os envolvidos na cadeia.' },

  { id:'Q15', q:'Recebi mensagem de cobrança indevida por PIX. O que devo fazer?', 
    a:['Pagar para evitar problema','Ignorar','Não pagar e registrar ocorrência','Esperar nova tentativa'], 
    c:2, tip:'Não pagar cobrança indevida; registre e comunique o banco ou Procon.' },

  { id:'Q16', q:'Propaganda promete “frete grátis” e depois inclui taxa no carrinho. Isso é…', 
    a:['Normal','Publicidade enganosa','Permitido em combos','Erro de sistema'], 
    c:1, tip:'Informação falsa ou omissa é publicidade enganosa.' },

  { id:'Q17', q:'Compra cancelada, mas a loja não devolve o valor. Qual o prazo máximo?', 
    a:['7 dias','10 dias úteis','Até 30 dias','Não há prazo definido'], 
    c:1, tip:'O reembolso deve ocorrer imediatamente após o cancelamento, em até 10 dias úteis.' },

  { id:'Q18', q:'O fornecedor não entrega manual em português. Pode vender assim?', 
    a:['Pode, se tiver QR code','Não; o manual deve estar em português','Apenas se for eletrônico','Somente se for importado'], 
    c:1, tip:'Informação clara e acessível é direito básico (art. 6º CDC).' },

  { id:'Q19', q:'Cobram “taxa de conveniência” no ingresso on-line. É legal?', 
    a:['Permitido se informado claramente','Proibido sempre','Permitido até R$5','Apenas se for evento público'], 
    c:0, tip:'É permitida se previamente informada e transparente.' },

  { id:'Q20', q:'Consumidor comprou remédio falsificado. O que deve fazer?', 
    a:['Guardar e usar assim mesmo','Denunciar à vigilância sanitária e ao Procon','Falar apenas com o vendedor','Não há como agir'], 
    c:1, tip:'Medicamento falsificado é crime; denuncie e exija substituição.' },

  { id:'Q21', q:'Empresa altera unilateralmente o plano de internet. Pode?', 
    a:['Pode, se avisar por e-mail','Não; só com consentimento do consumidor','Sempre pode ajustar valores','Se for para melhor, sim'], 
    c:1, tip:'Alterações contratuais dependem de informação e consentimento.' },

  { id:'Q22', q:'Produto em promoção tem os mesmos direitos de garantia?', 
    a:['Não, promoção anula garantia','Sim, garantia legal permanece','Apenas metade do prazo','Depende do tipo de desconto'], 
    c:1, tip:'Mesmo em promoção, direitos de garantia e troca se mantêm.' },

  { id:'Q23', q:'O consumidor tem direito a orçamento por escrito?', 
    a:['Não, apenas verbal','Sim, sempre antes do serviço','Só para consertos caros','Apenas se pedir'], 
    c:1, tip:'O orçamento deve ser apresentado antes de qualquer serviço pago.' },

  { id:'Q24', q:'O fornecedor pode reter parte do valor após cancelamento de compra on-line?', 
    a:['Sim, até 50%','Não, o reembolso deve ser total','Sim, se tiver taxa de administração','Apenas se for no cartão'], 
    c:1, tip:'Arrependimento garante reembolso total, inclusive frete.' },

  { id:'Q25', q:'O estacionamento danificou seu carro. O aviso “não nos responsabilizamos” vale?', 
    a:['Sim, se houver placa','Não, o fornecedor responde pelos danos','Depende do valor do carro','Apenas se for estacionamento gratuito'], 
    c:1, tip:'Responsabilidade objetiva por guarda de veículos.' },

  { id:'Q26', q:'Empresa compartilhou seus dados com terceiros sem autorização. Isso viola…', 
    a:['LGPD e CDC','Apenas o CDC','Apenas a LGPD','Nenhuma lei'], 
    c:0, tip:'Proteção de dados e privacidade: direito garantido pela LGPD e CDC.' },

  { id:'Q27', q:'Promoção “compre um, leve dois” sem estoque suficiente. O que o consumidor pode exigir?', 
    a:['Nada, acabou','Cumprimento da oferta ou restituição','Apenas outro produto similar','Desconto parcial'], 
    c:1, tip:'A oferta deve ser cumprida ou o valor devolvido.' },

  { id:'Q28', q:'O fornecedor prometeu instalação grátis, mas cobrou depois. Isso é…', 
    a:['Erro comum','Descumprimento de oferta','Venda casada','Negócio válido'], 
    c:1, tip:'Descumprimento de oferta obriga o cumprimento sem custo.' },

  { id:'Q29', q:'O consumidor pode exigir peça de reposição após o fim da produção?', 
    a:['Não, acabou a fabricação','Sim, por tempo razoável após a venda','Só se for produto caro','Somente no primeiro ano'], 
    c:1, tip:'Art. 32: fornecedor deve manter peças por tempo razoável.' },

  { id:'Q30', q:'Vício oculto aparece após o prazo de garantia. Ainda há direito?', 
    a:['Não, garantia acabou','Sim, novo prazo de 90 dias a partir da descoberta','Somente se o produto for caro','Depende do uso'], 
    c:1, tip:'Vício oculto renova prazo de reclamação ao ser descoberto.' },

  { id:'Q31', q:'Empresa promete “bônus em dinheiro” e não paga. O que fazer?', 
    a:['Esperar próxima campanha','Exigir cumprimento da oferta ou denunciar ao Procon','Pedir desconto na próxima compra','Ignorar'], 
    c:1, tip:'Oferta vincula o fornecedor; descumprimento gera direito à reparação.' },

  { id:'Q32', q:'O fornecedor se recusa a fornecer contato de SAC. Pode?', 
    a:['Pode, se for pequeno','Não; o atendimento é direito básico do consumidor','Sim, se tiver e-mail','Apenas por chat'], 
    c:1, tip:'SAC e canais de contato são obrigatórios (Decreto 6.523/2008).' }
];




function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function pick(n){
  const arr=shuffle(BANK.slice());
  const chosen = arr.slice(0,n); // simples e eficiente
  return chosen.map(it=>{
    const map=it.a.map((t,i)=>({t,i})); shuffle(map);
    return {q:it.q, a:map.map(m=>m.t), c:map.findIndex(m=>m.i===it.c), tip:it.tip};
  });
}

/* ---- Kiosk Mode ---- */
const KM_KEY = 'procon_kiosk_mode';
function applyKiosk(on){
  document.documentElement.classList.toggle('kiosk-on', !!on);
  if(on){ setTheme('light'); } // reduz reflexo
  setVH();
}
const savedKM = localStorage.getItem(KM_KEY) === '1';
applyKiosk(savedKM);
document.getElementById('btnKiosk').addEventListener('click', ()=>{
  const on = !document.documentElement.classList.contains('kiosk-on');
  ev('kiosk_toggle', { on });
  applyKiosk(on);
  localStorage.setItem(KM_KEY, on ? '1' : '0');
});

/* Timer */
function updateTimer(reset){
  const r=$('#timerRing'), n=$('#timerNum');
  if(reset){ r.style.strokeDashoffset='0'; r.style.stroke='var(--accent)'; n.textContent=S.time; return; }
  const p=Math.max(0,S.time/CONFIG.TIME);
  r.style.strokeDashoffset=String((1-p)*CIRC);
  r.style.stroke = (S.time<=10)?'#E5242A':'var(--accent)';
  n.textContent=S.time;
}

/* Splash/Toast */
async function splash(text='START'){ const d=document.createElement('div'); d.className='splash'; d.textContent=text; document.body.appendChild(d); await wait(700); d.remove(); }
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),1400); }

/* Contatos (local) */
function loadContacts(){ try{return JSON.parse(localStorage.getItem(CONFIG.KEYS.CONTACTS)||'[]')}catch{return[]} }
function saveContacts(list){ localStorage.setItem(CONFIG.KEYS.CONTACTS, JSON.stringify(list)); }
function addContact(c){ const list=loadContacts(); list.push({...c, id: Math.random().toString(36).slice(2), ts: Date.now()}); saveContacts(list); }

/* Normalização do WhatsApp (apenas dígitos, garante DDD 21) */
function normalizeWhats(s){
  const digits=(s||'').replace(/\D+/g,'').slice(0,9); // até 9 dígitos do número
  return '21' + digits.padEnd(9,''); // salva como 21xxxxxxxxx (11 dígitos)
}
function prettyWhats(s){
  const d=normalizeWhats(s);
  const n=d.slice(2);
  if(n.length<9) return `(21) ${n}`;
  return `(21) ${n[0]}${n.slice(1,5)}-${n.slice(5,9)}`;
}

/* Exportar contatos (.txt) */
async function exportContactsTxt(){
  const list=loadContacts();
  if(!list.length){ toast('Nenhum contato salvo ainda.'); return; }
  const header='nome\twhats\tinstagram\tquando\n';
  const rows=list.map(r=>`${(r.name||'').trim()}\t${(r.whats||'').trim()}\t${(r.insta||'').trim()}\t${new Date(r.ts).toLocaleString()}`).join('\n');
  const blob=new Blob([header+rows+'\n'],{type:'text/plain;charset=utf-8'});
  const stamp=new Date().toISOString().slice(0,10);
  const fname=`contatos-${stamp}.txt`;

  if(window.showSaveFilePicker){
    try{
      const handle=await showSaveFilePicker({suggestedName:fname, types:[{description:'Texto', accept:{'text/plain':['.txt']}}]});
      const w=await handle.createWritable(); await w.write(blob); await w.close(); toast('Arquivo salvo ✅');
      return;
    }catch(e){ /* cancelado; fallback abaixo */ }
  }
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();}, 800);
}

/* ===== Google Forms (submit via iframe) ===== */
const GF = {
  form: null,
  fields: { name: null, phone: null }
};
function initGForm(){
  GF.form = document.getElementById('gf');
  if(!GF.form) return;
  GF.fields.name  = document.getElementById('gf_name');
  GF.fields.phone = document.getElementById('gf_phone');
}
function submitToGForm({ name, phone }){
  if(!GF.form) return;
  GF.fields.name.value  = (name || '').trim();
  GF.fields.phone.value = String(phone || '').replace(/\D+/g,'').slice(0,11);
  try { GF.form.submit(); } catch(e){}
}

/* Fluxo do jogo */
async function reset(){
  S.pool=pick(CONFIG.N);
  S.idx=0; S.ok=0;
  S.lives=CONFIG.LIVES;
  S.score=0;
  S.time=CONFIG.TIME;
  S.lock=false;
  $('#score').textContent='0000';
  $('#lives').textContent='❤'.repeat(S.lives);
  $('#bar').style.width='0%';
  updateTimer(true);
}
async function start(){
  const name=($('#playerName').value||'').trim();
  const whatsRaw=($('#playerWhats').value||'').trim();
  let insta=($('#playerInsta').value||'').trim();
  if(insta && !insta.startsWith('@')) insta='@'+insta.replace(/^@+/,'');

  S.name = name || 'Jogador';
  S.whats = normalizeWhats(whatsRaw);
  S.insta = insta;

  addContact({name:S.name, whats:S.whats, insta:S.insta}); // local only
  submitToGForm({ name: S.name, phone: S.whats });        // envia para o Google Forms

  ev('quiz_start', { game_version:'v3.4', questions_total: CONFIG.N });

  await splash('START!'); ensureAudio(); try{audioCtx?.resume?.()}catch{}; sfx.start();
  await reset(); show('quiz'); nextQ();
  clearInterval(S.tick);
  S.tick=setInterval(()=>{ S.time--; updateTimer(); if(S.time<=0){ clearInterval(S.tick); over(); } },1000);
}

function nextQ(){
  if(S.idx>=S.pool.length){ return win(); }
  const it=S.pool[S.idx];
  $('#qtext').textContent=`Q${S.idx+1}/${S.pool.length}: ${it.q}`;
  const wrap=$('#answers'); wrap.innerHTML='';
  it.a.forEach((txt,i)=>{
    const b=document.createElement('button');
    b.className='answer';
    b.innerHTML=`<span class="key">${String.fromCharCode(65+i)}</span><span>${txt}</span>`;
    b.addEventListener('click',()=>choose(i,b,it));
    wrap.appendChild(b);
  });
  $('#bar').style.width = ((S.idx/S.pool.length)*100) + '%';
}

async function choose(i,btn,it){
  if(S.lock) return; S.lock=true;
  ev('answer_click', { q_index: S.idx+1, total: S.pool.length });
  const ok=i===it.c;
  if(ok){ btn.classList.add('correct'); S.ok++; S.score+=250; $('#score').textContent=pad4(S.score); sfx.ok(); toast(it.tip); }
  else{ btn.classList.add('wrong'); S.lives--; $('#lives').textContent='❤'.repeat(Math.max(0,S.lives)); sfx.bad(); if(S.lives<=0){ await wait(700); return over(); } }
  ev('answer_result', { q_index: S.idx+1, correct: !!ok, time_remaining: S.time, score: S.score });
  $$('.answer').forEach(b=>{ if(b!==btn) b.classList.add('disabled'); });
  await wait(900); S.idx++; S.lock=false; nextQ();
}

function prizeFor(ok,total){ if(ok===total) return 'Melhor Prêmio'; if(ok>=Math.ceil(total/2)) return 'Prêmio Médio'; if(ok===0) return 'CDC comentado'; return '—'; }
function uuid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function finish(title){
  const total=S.pool.length;
  const entry={ id:uuid(), name:S.name||'Jogador', correct:S.ok, total, score:S.score, time:Math.max(0,S.time), prize:prizeFor(S.ok,total), ts:Date.now() };
  const board=addBoard(entry);
  $('#resultTitle').textContent=`${title}, ${S.name || 'Jogador'}! 🎉`;
  $('#hits').textContent=`${S.ok}/${total}`; $('#finalScore').textContent=pad4(S.score);
  renderBoard('#boardTable',board);
  ev('quiz_finish', { result_title: title, correct: S.ok, total, score: S.score, time_remaining: S.time });
  show('result');
}
function win(){ clearInterval(S.tick); sfx.win(); splash('WIN!').then(()=>finish('PARABÉNS')); }
function over(){ clearInterval(S.tick); sfx.over(); splash('FIM DE JOGO').then(()=>finish('FIM DE JOGO')); }

/* Leaderboard */
function loadBoard(){ try{return JSON.parse(localStorage.getItem(CONFIG.KEYS.BOARD)||'[]')}catch{return[]} }
function saveBoard(list){ localStorage.setItem(CONFIG.KEYS.BOARD, JSON.stringify(list)); }
function addBoard(entry){ const list=loadBoard(); list.push(entry); list.sort((a,b)=>(b.score-a.score)||(b.time-a.time)); const top=list.slice(0,CONFIG.BOARD); saveBoard(top); return top; }
function renderBoard(sel,list=loadBoard()){
  const t=$(sel); if(!t) return;
  if(!list.length){ t.innerHTML='<tr><td style="padding:6px 0">Sem resultados ainda.</td></tr>'; return; }
  let rows='<tr><th style="text-align:left;padding:6px 4px">#</th><th style="text-align:left">Nome</th><th>Acertos</th><th>Score</th><th>Tempo</th><th>Quando</th></tr>';
  rows+=list.map((r,i)=>`<tr>
    <td style="padding:6px 4px">${i+1}</td>
    <td>${(r.name||'').replace(/[&<>"']/g,'')}</td>
    <td style="text-align:center">${r.correct}/${r.total}</td>
    <td style="text-align:center">${pad4(r.score)}</td>
    <td style="text-align:center">${r.time}s</td>
    <td>${new Date(r.ts).toLocaleString()}</td>
  </tr>`).join('');
  t.innerHTML=rows;
}

/* Validação */
const nameInput=$('#playerName'), whatsInput=$('#playerWhats'), instaInput=$('#playerInsta');
function validWhats(s){
  const d=(s||'').replace(/\D+/g,'');
  return d.length>=8; // ideal: 9 dígitos no RJ
}
function validateForm(){
  const name=(nameInput.value||'').trim();
  const phone=(whatsInput.value||'').trim();
  $('#btnStart').disabled = !(name.length>1 && validWhats(phone));
}
[nameInput,whatsInput,instaInput].forEach(el=>el.addEventListener('input', validateForm));

/* Controles principais */
$('#btnStart').addEventListener('click', e=>{ e.preventDefault(); start(); });
$('#btnAgain').addEventListener('click', e=>{
  e.preventDefault();
  ev('play_again_click', {});
  clearInterval(S.tick);
  S.time=CONFIG.TIME; updateTimer(true);
  $('#score').textContent='0000';
  $('#lives').textContent='❤'.repeat(CONFIG.LIVES);
  nameInput.value=''; whatsInput.value=''; instaInput.value='';
  S.name='Jogador'; S.whats=''; S.insta='';
  $('#btnStart').disabled=true;
  show('start');
});
$('#btnReset').addEventListener('click', ()=>{
  clearInterval(S.tick); show('start');
  nameInput.value=''; whatsInput.value=''; instaInput.value='';
  $('#btnStart').disabled=true; S.name='Jogador'; S.whats=''; S.insta='';
  $('#score').textContent='0000'; $('#lives').textContent='❤❤❤';
  updateTimer(true);
  renderBoard('#boardTable');
});
$('#btnClearBoard').addEventListener('click', ()=>{ if(confirm('Limpar ranking local?')){ localStorage.setItem(CONFIG.KEYS.BOARD,'[]'); renderBoard('#boardTable'); }});
$('#btnMute').addEventListener('click',()=>{
  S.muted=!S.muted;
  ev('mute_toggle', { muted: S.muted });
  $('#btnMute').textContent=S.muted?'🔇':'🔊';
  $('#btnMute').setAttribute('aria-pressed', String(!S.muted));
});
$('#btnExport').addEventListener('click', exportContactsTxt);

/* Boot */
(function boot(){
  initGForm();              // inicializa integração com Google Forms
  renderBoard('#boardTable');
  updateTimer(true);
  validateForm();
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <!-- viewport fit para iOS (notch) + layout responsivo -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Quiz do Consumidor — SEDCON/Procon-RJ</title>

  <!-- fontes -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;700;800&display=swap" rel="stylesheet">

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#24A653">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <style>
    /* ======================================================
       TEMAS (padrão, alto contraste, daltônico-safe)
       ====================================================== */
    :root{
      --sedcon-green:#24A653; --sedcon-red:#E5242A; --sedcon-yellow:#FFDA3A;

      --bg:#0b0b16; --panel:#111639cc; --text:#ecf2ff; --muted:#a9b7d7;
      --brand:var(--sedcon-green); --brand-hi:#9dffcf; --accent:var(--sedcon-yellow); --danger:var(--sedcon-red);
      --ok:#37e086; --answer:#1b2256; --answer-ok:#135a2c; --answer-bad:#6b1c2a; --ring:#ffffff2e;
      --shadow:0 22px 48px rgba(0,0,0,.35); --radius:18px;
      color-scheme: dark;
    }
    .theme-contrast{
      --bg:#000; --panel:#000; --text:#fff; --muted:#ddd; --brand:#00ff00; --brand-hi:#b6ffb6;
      --accent:#ffff00; --danger:#ff0033; --ok:#00ff99; --answer:#111; --answer-ok:#004d1a; --answer-bad:#4d0010; --ring:#fff3; --shadow:none;
    }
    .theme-cvd{
      --bg:#09111e; --panel:#0d1430cc; --text:#f3f6ff; --muted:#c7cfe6; --brand:#2aa6f2; --brand-hi:#89d4ff;
      --accent:#ffd166; --danger:#ff6b6b; --ok:#ffd166; --answer:#1a234d; --answer-ok:#1c4f7a; --answer-bad:#6b2f4a; --ring:#ffffff2e;
    }

    /* ======================================================
       BASE / RESET
       ====================================================== */
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}
    .pixel{font-family:"Press Start 2P",monospace}
    .muted{color:var(--muted)}

    /* palco em 100% do viewport (com fallback --vh para iOS/Android antigos) */
    .stage{
      position:relative; display:grid; grid-template-rows:auto 1fr auto;
      width:100%; height:100dvh; height:calc(var(--vh, 1vh)*100);
      background: radial-gradient(1400px 1100px at 20% 8%, #15203f 0%, var(--bg) 45%, #090913 100%);
    }

    /* topo e rodapé */
    .header,.footer{
      display:flex; align-items:center; justify-content:space-between; gap:clamp(8px,1.6vw,16px);
      padding:clamp(8px,2vh,18px) clamp(12px,2vw,24px);
      background:linear-gradient(180deg,#0f1530cc,#0a0f26a6); border-bottom:1px solid var(--ring); backdrop-filter:blur(8px)
    }
    .footer{border-top:1px solid var(--ring); border-bottom:none; justify-content:center; flex-wrap:wrap;}

    /* marca */
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:clamp(42px,6vh,66px);height:clamp(42px,6vh,66px);border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-hi));box-shadow:inset 0 0 0 4px #0008,0 8px 20px #0007;display:grid;place-items:center;color:#012;font-weight:800}
    .title b{display:block;font-size:clamp(18px,3.6vw,28px)}
    .title span{display:block;font-size:clamp(11px,2.2vw,14px);color:var(--muted)}

    /* === TOOLBAR do topo (botões) === */
    .toolbar{ display:flex; align-items:center; gap:clamp(8px,1.4vw,14px); flex-wrap:wrap; justify-content:flex-end; }
    .toolbar .btn{ min-height:44px; min-width:auto; padding:.8em 1.1em; }

    /* área principal com sidebar à esquerda */
    .screen{display:flex;align-items:center;justify-content:center;padding:clamp(10px,2vh,22px);overflow:visible}
    .workspace{ display:grid; grid-template-columns: 1fr; gap: clamp(12px,2vw,20px); width:100%; }
    @media (min-width: 1100px){ .workspace{ grid-template-columns: 320px 1fr; align-items:start; } }

    .sidebar{ display:none; }
    @media (min-width: 1100px){ .sidebar{ display:block; } }
    .sidebar .board{ position:sticky; top:clamp(8px,2vh,16px); }

    /* card central */
    .card{
      width:min(1100px,96vw); max-height:calc(100dvh - 160px); max-height:calc((var(--vh,1vh)*100) - 160px);
      background:linear-gradient(180deg,var(--panel),var(--panel)); backdrop-filter:blur(10px);
      border:4px solid #000; border-radius:var(--radius); box-shadow:var(--shadow);
      padding:clamp(14px,3vh,28px); position:relative; overflow:auto;
    }
    .glow{position:absolute;inset:-40%;background:radial-gradient(600px 600px at 85% 20%, color-mix(in oklab, var(--brand) 20%, transparent), transparent 60%);pointer-events:none}

    /* mini HUD dentro do quiz */
    .miniHud{ display:flex; align-items:center; justify-content:center; gap:clamp(8px,1.4vw,14px); flex-wrap:wrap; margin-bottom:clamp(8px,1.6vw,14px); }
    .chip{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;background:#0d1130;border:3px solid #000;border-radius:12px;box-shadow:inset 0 -4px 0 rgba(0,0,0,.5),0 4px 0 #000;font-weight:800;font-size:clamp(12px,2.2vw,14px)}
    .timerWrap{position:relative;width:clamp(64px,9vw,110px);height:clamp(64px,9vw,110px);display:grid;place-items:center}
    .timerSvg{transform:rotate(-90deg)} .timerRingBg{stroke:#000;opacity:.6}
    .timerRing{stroke:var(--accent);transition:stroke-dashoffset .25s linear}
    .timerNum{position:absolute;font-weight:800;font-size:clamp(16px,2.6vw,22px)}

    /* botões */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;background:linear-gradient(180deg,var(--brand),color-mix(in oklab,var(--brand) 75%,#000));color:#021;padding:clamp(12px,2vh,18px) clamp(16px,4vw,26px);border:4px solid #000;border-radius:14px;font-weight:800;letter-spacing:.4px;font-size:clamp(14px,2.4vw,18px);box-shadow:0 10px 0 #000;cursor:pointer;user-select:none;text-decoration:none;min-height:54px;min-width:clamp(140px,28vw,240px)}
    .btn:active{transform:translateY(4px);box-shadow:0 6px 0 #000}
    .btn.alt{background:linear-gradient(180deg,var(--accent),#b48a1d);color:#331}
    .btn.ghost{background:transparent;color:var(--text);border-color:#333}
    .btn.danger{background:linear-gradient(180deg,var(--danger),#8a1017);color:#fff}
    .cta{display:flex;flex-wrap:wrap;gap:clamp(10px,2vw,22px);justify-content:center;margin-top:14px}

    /* formulários */
    .inputs{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px;width:100%}
    .text{padding:14px 16px;border:4px solid #000;border-radius:12px;font-weight:800;font-size:clamp(14px,2.4vw,18px);width:min(560px,94vw);background:#0d1130;color:#fff;box-shadow:inset 0 -4px 0 rgba(0,0,0,.5),0 4px 0 #000}

    /* textos */
    .hero{text-align:center;padding:clamp(10px,2vh,20px)}
    .hero .t{font-size:clamp(20px,6.2vw,38px);color:var(--accent);text-shadow:0 4px 0 #000,0 0 18px color-mix(in oklab, var(--accent) 40%, transparent)}
    .hero .s{font-size:clamp(12px,3.5vw,16px);color:var(--muted);margin-top:6px}
    .question{font-size:clamp(16px,4.5vw,22px);text-shadow:0 3px 0 #000;font-weight:800;text-align:center}

    /* respostas */
    .answers{width:min(1000px,100%);display:grid;gap:clamp(10px,2vw,18px);margin:clamp(14px,2vh,22px) auto 0;grid-template-columns:1fr}
    @media (min-width:700px){.answers{grid-template-columns:repeat(2,minmax(260px,1fr))}}
    @media (min-width:1200px){.answers{grid-template-columns:repeat(2,minmax(320px,1fr))}}
    .answer{display:flex;align-items:center;gap:14px;text-align:left;padding:clamp(12px,2vh,20px) clamp(14px,2vw,22px);background:var(--answer);color:#fff;border:4px solid #000;border-radius:14px;font-size:clamp(14px,2.4vw,18px);box-shadow:0 10px 0 #000;cursor:pointer;user-select:none;transition:transform .08s ease;min-height:clamp(56px,7vh,76px)}
    .answer:active{transform:translateY(4px)} .answer:focus-visible{outline:none;box-shadow:0 0 0 4px #000,0 0 0 6px var(--accent)}
    .key{display:inline-grid;place-items:center;width:38px;height:38px;min-width:38px;border:3px solid #333;border-radius:10px;background:#000;color:var(--accent);font-weight:800}
    .answer.correct{background:var(--answer-ok)} .answer.wrong{background:var(--answer-bad)} .answer.disabled{opacity:.6;pointer-events:none}

    /* barra de progresso */
    .progress{margin:12px auto 0;width:min(720px,100%);height:clamp(12px,1.8vh,18px);background:#000;border:4px solid #000;border-radius:9px;overflow:hidden;position:relative}
    .progress i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand-hi))}
    .progress .tick{position:absolute;inset:0;background:repeating-linear-gradient(90deg,transparent 0,transparent calc(100%/5 - 2px),#000 calc(100%/5 - 2px),#000 calc(100%/5));opacity:.25}

    /* feedback grande e piscando */
    .toast{position:fixed;left:50%;top:55%;transform:translate(-50%,-50%);background:#000;border:4px solid #fff;border-radius:12px;padding:14px 16px;font-weight:700;z-index:50;max-width:min(90vw,640px);text-align:center;
           font-size:clamp(16px, 3.8vw, 22px); animation: toastPop .18s ease both, toastBlink 1.1s steps(2,end) 3 .25s; }
    @keyframes toastPop{ from{ transform:translate(-50%,-50%) scale(.9)} to{ transform:translate(-50%,-50%) scale(1)} }
    @keyframes toastBlink{ 50%{ opacity:.35 } }

    /* resultado + ranking */
    .resultBox{display:grid;gap:12px;justify-items:center;text-align:center;padding-top:6px}
    .badge{display:inline-grid;place-items:center;padding:12px 16px;border-radius:999px;border:3px solid #000;box-shadow:0 6px 0 #000;background:#0c133d;color:#fff;font-weight:800}
    .prize{margin-top:6px;padding:12px 14px;border:4px dashed #000;border-radius:14px;background:linear-gradient(180deg,#16205b,#0e1541);font-weight:800}

    .board{margin-top:14px;width:100%;border:4px solid #000;border-radius:14px;overflow:hidden;background:#0d1130;box-shadow:0 10px 0 #000}
    .board header{padding:10px 12px;background:#000;font-weight:800;display:flex;justify-content:space-between}
    .board table{width:100%;border-collapse:collapse}
    .board th,.board td{padding:10px 12px;text-align:left;border-bottom:1px solid #000}
    .board tr:last-child td{border-bottom:none}
    .tag{display:inline-block;padding:2px 8px;border:2px solid #000;border-radius:999px;background:#182048;font-weight:800;font-size:.9em}

    /* splash 8-bit – transição mais lenta */
    .splash{position:fixed;inset:0;background:#000;z-index:99;display:grid;place-items:center;pointer-events:none;color:var(--accent);font-weight:800;font-size:clamp(18px,4vw,28px);letter-spacing:1px;animation:splashFade .9s ease both}
    @keyframes splashFade{0%{opacity:0}10%{opacity:1}100%{opacity:0}}
    .splash .wipe{position:absolute;inset:0;background:radial-gradient(circle at 50% 50%,#fff 0 6px,transparent 7px) repeat;background-size:14px 14px;opacity:.15;mix-blend-mode:screen;animation:wipePix .9s steps(6,end) both}
    @keyframes wipePix{from{transform:scale(1.6)}to{transform:scale(1)}}

    /* grid retro de fundo (canvas) */
    #bg8bit{position:fixed;inset:0;width:100dvw;height:100dvh;opacity:.28;pointer-events:none;background:linear-gradient(transparent 95%,rgba(255,255,255,.05) 95%) 0 0/100% 32px,linear-gradient(90deg,transparent 95%,rgba(255,255,255,.05) 95%) 0 0/32px 100%}

    /* remove scrollbars residuais */
    body::-webkit-scrollbar{display:none}

    /* ========== MOBILE HOTFIX (iOS/Android) ========== */

/* 1) Permite rolagem vertical global (acabou o corte de conteúdo) */
html, body{
  overflow-x: hidden;
  overflow-y: auto;          /* era hidden */
}

/* 2) A tela deixa de ser “altura fixa” em telas estreitas
      (ainda ocupa no mínimo a altura visível do dispositivo) */
@media (max-width: 768px){
  .stage{
    height: auto;            /* era 100dvh preso */
    min-height: 100svh;      /* usa Safe Viewport Height */
  }
  .screen{
    align-items: stretch;
    justify-content: flex-start;
    padding: clamp(10px, 2vh, 22px);
    overflow: visible;       /* sem “scroll dentro do card” */
  }
  /* 3) O card pode crescer o quanto precisar (sem max-height) */
  .card{
    width: 100%;
    max-width: 1100px;
    max-height: none;        /* remove limite que criava scroll interno */
    height: auto;
  }
  /* 4) Toolbar quebra bonitinho e centraliza */
  .toolbar{
    justify-content: center;
    gap: 10px;
  }
  .toolbar .btn{
    min-width: auto;
    padding: .7em 1em;
  }
  /* 5) Ranking lateral continua oculto no mobile (para não empurrar largura) */
  .sidebar{ display: none !important; }
}

/* 6) Evita qualquer barra horizontal por “sobra” de 1px */
* { max-width: 100vw; }

/* 7) Botões de resposta ocupam 100% e têm respiro confortável */
.answers{ width: 100%; }
.answer{ width: 100%; }

/* 8) Footer com espaço para a área segura do iPhone */
.footer{ padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 8px); }

  
  </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-05H6KL6ZF1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-05H6KL6ZF1');
</script>


<body>

<script>
  function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
  setVH();
  addEventListener('resize', setVH);
  addEventListener('orientationchange', ()=>setTimeout(setVH, 300));
  /* NOVO: muitos navegadores móveis disparam 'visibilitychange' após UI do navegador alterar a altura */
  document.addEventListener('visibilitychange', ()=>setTimeout(setVH, 300));
</script>


<!-- fundo retro -->
<canvas id="bg8bit" aria-hidden="true"></canvas>

<div class="stage">
  <!-- ======================================================
       HEADER: marca à esquerda + TOOLBAR à direita
       ====================================================== -->
  <header class="header" role="banner">
    <div class="brand">
      <div class="logo pixel" aria-hidden="true">QC</div>
      <div class="title">
        <b class="pixel">Quiz do Consumidor</b>
        <span>SEDCON / Procon-RJ — Direitos do Consumidor</span>
      </div>
    </div>

    <!-- toolbar substitui o HUD antigo do topo -->
    <div class="toolbar">
      <button id="btnFull" class="btn ghost" type="button" aria-label="Ativar tela cheia">Tela cheia</button>
      <button id="btnReset" class="btn danger" type="button" aria-label="Resetar jogo (staff)">Reset</button>
      <button id="btnGuide" class="btn ghost" type="button" aria-label="Guia staff">Guia</button>
      <button id="btnViewBoard" class="btn alt" type="button" aria-label="Ver ranking">Ver Ranking</button>

      <div class="chip" style="gap:6px">
        <label class="muted" for="themeSel">Tema:</label>
        <select id="themeSel" class="btn ghost" style="padding:.6em 1em;font-weight:700">
          <option value="default">Padrão</option>
          <option value="contrast">Alto contraste</option>
          <option value="cvd">Daltônico-safe</option>
        </select>
      </div>

      <button id="btnMute" class="btn ghost" type="button" aria-pressed="true" title="Som">🔇</button>
    </div>
  </header>

  <!-- ======================================================
       MAIN: workspace (sidebar esquerda + conteúdo)
       ====================================================== -->
  <main class="screen" role="main">
    <div class="workspace">

      <!-- Sidebar: Ranking fixo (aparece em >=1100px) -->
      <aside id="sidebar" class="sidebar" aria-label="Ranking lateral">
        <div class="board">
          <header><span>Ranking — Top 5</span><span class="tag">local</span></header>
          <table id="boardTableSide"></table>
        </div>
      </aside>

      <!-- Conteúdo principal -->
      <div class="card">
        <div class="glow" aria-hidden="true"></div>

        <!-- START ------------------------------------------------>
        <section id="start" class="hero" aria-labelledby="startTitle">
          <div id="startTitle" class="t pixel">Bem-vindo ao <span style="color:var(--brand)">Quiz do Consumidor</span></div>
          <div class="s">Digite seu nome e toque em Iniciar</div>

          <div class="inputs">
            <input id="playerName" class="text" type="text" inputmode="text" maxlength="24" placeholder="Seu nome"
                   aria-label="Nome do participante">
          </div>

          <div class="cta">
            <button id="btnStart" class="btn pixel" type="button" disabled>INICIAR</button>
          </div>

          <!-- guia rápido para equipe -->
          <div id="guide" class="board" style="display:none">
            <header><span>Guia rápido (staff)</span><span class="tag">operação</span></header>
            <div style="padding:12px">
              <ol style="margin:0;padding-left:18px;line-height:1.5">
                <li>Abrir <b>index.html</b>; tocar <b>Tela cheia</b> (ou F11).</li>
                <li>Som inicia <b>mutado</b>; ative no 🔊 se desejar.</li>
                <li>Jogador digita <b>nome</b> e toca <b>Iniciar</b>.</li>
                <li>Ao final: mostra <b>acertos / score / brinde</b>.</li>
                <li><b>Top 5</b> na lateral; botão <b>Limpar Ranking</b> zera a lista.</li>
                <li><b>Reset</b> volta ao início e limpa o nome atual.</li>
                <li>Temas: Padrão / Alto contraste / Daltônico-safe.</li>
              </ol>
            </div>
          </div>
        </section>

        <!-- QUIZ ------------------------------------------------->
        <section id="quiz" hidden aria-live="polite">
          <!-- mini-HUD **dentro** do quiz -->
          <div class="miniHud" aria-label="Status da partida">
            <div class="timerWrap" aria-live="polite" aria-atomic="true">
              <svg class="timerSvg" width="100%" height="100%" viewBox="0 0 120 120" role="img" aria-label="Tempo restante">
                <circle class="timerRingBg" cx="60" cy="60" r="52" fill="none" stroke-width="12"></circle>
                <circle id="timerRing" class="timerRing" cx="60" cy="60" r="52" fill="none" stroke-width="12"
                        stroke-linecap="round" stroke-dasharray="326.7256" stroke-dashoffset="0"></circle>
              </svg>
              <div id="timerNum" class="timerNum pixel" aria-live="polite">60</div>
            </div>
            <div class="chip">Score: <span id="score" class="pixel">0000</span></div>
            <div class="chip pixel" id="lives" aria-live="polite" aria-atomic="true">❤❤❤</div>
          </div>

          <h2 class="question" id="qtext">Pergunta…</h2>
          <div class="progress" aria-hidden="true"><i id="bar"></i><div class="tick"></div></div>
          <div class="answers" id="answers" role="list"></div>
        </section>

        <!-- RESULT ------------------------------------------------>
        <section id="result" hidden class="resultBox" aria-live="polite" aria-atomic="true">
          <div class="t pixel" id="resultTitle">RESULTADO</div>
          <div class="badge" style="background:#001a0d"><span style="opacity:.8;margin-right:6px">Acertos</span><span id="hits" class="pixel" style="font-size:1.1em">0/0</span></div>
          <div class="badge" style="background:#1b0033"><span style="opacity:.8;margin-right:6px">Score</span><span id="finalScore" class="pixel" style="font-size:1.1em">0000</span></div>
          <div id="prizeBox" class="prize">Brinde: —</div>

          <div class="cta">
            <button id="btnAgain" class="btn alt pixel" type="button">JOGAR NOVAMENTE</button>
            <button id="btnClearBoard" class="btn danger" type="button" title="Limpar ranking (staff)">Limpar Ranking</button>
          </div>

          <div class="tag" id="playerPlacement" aria-live="polite" style="margin-top:8px">—</div>
          <div class="muted" style="font-size:clamp(11px,2.2vw,14px)">Mostre à equipe para receber o brinde.</div>
        </section>
      </div>
    </div>
  </main>

  <!-- ======================================================
       FOOTER
       ====================================================== -->
  <footer class="footer" role="contentinfo">
    <div class="muted">SEDCON / Procon-RJ</div>
    <div class="muted">Versão 2.2 · Kiosk-ready</div>
  </footer>
</div>

<!-- Perguntas adicionais (pode editar/expandir). Serão misturadas e 5 são sorteadas por partida. -->
<script id="extra-questions" type="application/json">
[
  {"q":"Qual é o objetivo do Código de Defesa do Consumidor?","a":["Proteger consumidores e garantir práticas justas","Punir apenas fornecedores","Definir só regras de publicidade"],"c":0,"tip":"CDC equilibra relações de consumo."},
  {"q":"Quem é considerado consumidor segundo o CDC?","a":["Apenas pessoa física","Pessoa física ou jurídica que adquire/usa produto/serviço","Somente quem compra pela internet"],"c":1,"tip":"Art. 2º: destinatário final."},
  {"q":"Quais são os direitos básicos do consumidor?","a":["Informação, proteção contra abusos e reparação","Sempre pagar metade do preço","Troca sem motivo após 30 dias"],"c":0,"tip":"Art. 6º — direitos básicos."},
  {"q":"O que fazer se um produto apresentar defeito?","a":["Substituição, reembolso ou conserto","Esperar 90 dias obrigatoriamente","Chamar a transportadora"],"c":0,"tip":"Fornecedor deve sanar o vício."},
  {"q":"Como denunciar publicidade enganosa?","a":["PROCON ou Ministério Público","Aceitar a oferta e depois reclamar","Não é possível"],"c":0,"tip":"Publicidade enganosa é vedada."},
  {"q":"Preço menor na gôndola vs caixa:","a":["Vale o do caixa","Vale o menor preço","Divide ao meio"],"c":1,"tip":"Prevalece o menor."}
]
</script>

<script>
  /* ============================================================
     LÓGICA DO JOGO — compacta e comentada
     ============================================================ */

  /* utilidades curtas */
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const wait=ms=>new Promise(r=>setTimeout(r,ms));
  const pad4=n=>String(n).padStart(4,'0');
  const show=id=>['start','quiz','result'].forEach(k=>document.getElementById(k).hidden=(k!==id));

  /* configuração */
  const CONFIG={QUESTIONS_PER_GAME:5,TIME_SECONDS:60,LIVES:3,BOARD_SIZE:5,STORAGE_KEYS:{BOARD:'procon_leaderboard',THEME:'procon_theme'}};

  /* banco base + merge do bloco JSON inline */
  const BANK=[
    { q:'Comprou pela internet e se arrependeu. Pode devolver?', a:['Não','Sim, em até 7 dias','Só se tiver defeito'], c:1, tip:'Direito de arrependimento (7 dias).' },
    { q:'Cobrança indevida paga: seu direito é…', a:['Nada','Devolver o valor','Devolução em dobro'], c:2, tip:'Repetição do indébito em dobro.' },
    { q:'Produto entregue diferente do contratado:', a:['Aceitar a variação','Exigir o contratado ou cancelar','Pedir 10% de desconto'], c:1, tip:'Entrega deve corresponder.' },
    { q:'Recebeu produto não solicitado com boleto:', a:['Não pagar (é amostra grátis)','Pagar','Só se abrir a caixa'], c:0, tip:'Envio sem pedido é proibido.' },
    { q:'Preço menor na gôndola vs caixa:', a:['Vale o do caixa','Vale o menor preço','Divide ao meio'], c:1, tip:'Prevalece o menor.' }
  ];

  /* estado */
  const S={name:'Jogador',pool:[],idx:0,correct:0,lives:CONFIG.LIVES,score:0,time:CONFIG.TIME_SECONDS,ticking:null,lock:false,muted:true,bgRunning:false};

  /* áudio 8-bit leve (ativado após interação) */
  let audioCtx=null;
  function ensureAudio(){ if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} } }
  function blip(type,freq,dur,vol){ if(!audioCtx||S.muted) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type=type;o.frequency.value=freq;g.gain.value=vol;o.connect(g);g.connect(audioCtx.destination);o.start();setTimeout(()=>{try{o.stop();}catch{}},Math.max(60,dur*1000)); }
  const sfx={ start(){[523,659,784].forEach((f,i)=>setTimeout(()=>blip('square',f,.09,.25),i*110));},
              ok(){blip('square',880,.09,.3);}, bad(){blip('sawtooth',160,.14,.3);},
              win(){[659,784,988,1174].forEach((f,i)=>setTimeout(()=>blip('square',f,.09,.3),i*120));},
              over(){[392,330,262].forEach((f,i)=>setTimeout(()=>blip('triangle',f,.12,.3),i*150));}};

  /* helpers de banco e aleatorização */
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  async function loadBank(){
    let bank=BANK.slice();
    const tag=$('#extra-questions'); if(tag){ try{ bank=bank.concat(JSON.parse(tag.textContent.trim())); }catch{} }
    try{ const r=await fetch('quiz.json',{cache:'no-store'}); if(r.ok) bank=bank.concat(await r.json()); }catch{}
    const seen=new Set(); return bank.filter(it=>!seen.has(it.q)&&seen.add(it.q));
  }
  const RECENT_KEY='procon_recent_q', RECENT_SIZE=10;
  const loadRecent=()=>{try{return JSON.parse(localStorage.getItem(RECENT_KEY)||'[]')}catch{return[]}};
  const saveRecent=list=>localStorage.setItem(RECENT_KEY, JSON.stringify(list.slice(-RECENT_SIZE)));
  function pickQuestions(bank,n){ const recent=new Set(loadRecent()); const pool=bank.filter(it=>!recent.has(it.q)); const src=(pool.length>=n)?pool:bank; shuffle(src); const chosen=src.slice(0,n); saveRecent(loadRecent().concat(chosen.map(it=>it.q))); return chosen;}
  function shuffleAnswers(it){ const pairs=it.a.map((txt,i)=>({txt,i})); shuffle(pairs); return {a:pairs.map(p=>p.txt), c:pairs.findIndex(p=>p.i===it.c)}; }

  /* UI do timer */
  const CIRC=326.7256; const ring=()=>$('#timerRing'), num=()=>$('#timerNum');
  function updateTimerUI(reset=false){
    if(reset){ ring().style.strokeDashoffset='0'; num().textContent=S.time; return; }
    const p=Math.max(0,S.time/CONFIG.TIME_SECONDS);
    ring().style.strokeDashoffset=String((1-p)*CIRC);
    num().textContent=S.time;
    ring().style.stroke=(S.time<=10)?getComputedStyle(document.documentElement).getPropertyValue('--danger'):getComputedStyle(document.documentElement).getPropertyValue('--accent');
  }

  /* splash entre telas (transição mais lenta) */
  async function showSplash(text='START'){
    const d=document.createElement('div'); d.className='splash'; d.innerHTML=`<div class="wipe"></div><div class="pixel">${text}</div>`;
    document.body.appendChild(d); await wait(900); d.remove();
  }

  /* grade retro dinâmica (decorativo) */
  function startBg(){ if(S.bgRunning) return; S.bgRunning=true;
    const cv=$('#bg8bit'); const ctx=cv.getContext('2d');
    function resize(){ cv.width=innerWidth; cv.height=innerHeight;} resize(); addEventListener('resize',resize);
    const cols=12, cell=Math.max(26,Math.min(48,Math.floor(innerWidth/cols))); const rows=Math.ceil(innerHeight/cell)+2;
    const blocks=Array.from({length:cols},(_,x)=>({x, y:-Math.random()*rows, speed:0.05+Math.random()*0.12})); let last=0;
    function step(ts){ const dt=Math.min(64,ts-last); last=ts; if(document.hidden){ requestAnimationFrame(step); return; }
      ctx.clearRect(0,0,cv.width,cv.height); ctx.globalAlpha=.25; ctx.fillStyle='#fff';
      blocks.forEach(b=>{ b.y+=b.speed*dt/16; if(b.y>rows) b.y=-2; const px=b.x*cell+cell*.15, py=Math.floor(b.y)*cell+cell*.15, w=cell*.7, h=cell*.7; ctx.fillRect(px,py,w*.45,h*.45); ctx.fillRect(px+w*.55,py,w*.45,h*.45); ctx.fillRect(px,py+h*.55,w*.45,h*.45);});
      ctx.globalAlpha=1; requestAnimationFrame(step);
    } requestAnimationFrame(step);
  }

  /* fluxo principal */
  async function reset(){
    const bank=await loadBank();
    S.pool=pickQuestions(bank,CONFIG.QUESTIONS_PER_GAME).map(it=>{const{a,c}=shuffleAnswers(it);return{q:it.q,a,c,tip:it.tip}});
    S.idx=0; S.correct=0; S.lives=CONFIG.LIVES; S.score=0; S.time=CONFIG.TIME_SECONDS; S.lock=false;
    $('#score').textContent='0000'; $('#lives').textContent='❤'.repeat(S.lives); $('#bar').style.width='0%'; updateTimerUI(true);
  }
  async function startGame(){
    await showSplash('START!');
    ensureAudio(); try{audioCtx&&audioCtx.resume&&audioCtx.resume();}catch{}
    sfx.start(); await reset(); show('quiz'); nextQ();
    clearInterval(S.ticking);
    S.ticking=setInterval(()=>{ S.time--; updateTimerUI(); if(S.time<=0){ clearInterval(S.ticking); gameOver(); } },1000);
  }
  function nextQ(){
    if(S.idx>=S.pool.length) return win();
    const it=S.pool[S.idx];
    $('#qtext').textContent=`Q${S.idx+1}/${S.pool.length}: ${it.q}`;
    const wrap=$('#answers'); wrap.innerHTML='';
    it.a.forEach((txt,i)=>{ const b=document.createElement('button'); b.className='answer'; b.innerHTML=`<span class="key pixel">${String.fromCharCode(65+i)}</span><span>${txt}</span>`; b.addEventListener('click',()=>choose(i,b,it),{once:true}); b.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); b.click(); }}); wrap.appendChild(b); });
    $('#bar').style.width=`${(S.idx/S.pool.length)*100}%`;
  }
  async function choose(i,btn,it){
    if(S.lock) return; S.lock=true;
    const ok=i===it.c;
    if(ok){ btn.classList.add('correct'); S.correct++; S.score+=250; $('#score').textContent=pad4(S.score); sfx.ok(); toast(it.tip); }
    else{ btn.classList.add('wrong'); S.lives--; $('#lives').textContent='❤'.repeat(Math.max(0,S.lives)); sfx.bad(); if(S.lives<=0){ await wait(900); return gameOver(); } }
    $$('.answer').forEach(b=>{ if(b!==btn) b.classList.add('disabled'); });
    await wait(1200); /* transição mais lenta */
    S.idx++; S.lock=false; nextQ();
  }

  /* encerramento + prêmios */
  function prizeFor(correct,total){ if(correct===total) return 'Melhor Prêmio'; if(correct>=Math.ceil(total/2)) return 'Prêmio Médio'; if(correct===0) return 'CDC comentado'; return '—'; }
  function uuid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function win(){ clearInterval(S.ticking); sfx.win(); $('#bar').style.width='100%'; showSplash('WIN!').then(()=>finish('PARABÉNS! 🎉')); }
  function gameOver(){ clearInterval(S.ticking); sfx.over(); showSplash('GAME OVER').then(()=>finish('FIM DE JOGO')); }
  function finish(title){
    const total=S.pool.length;
    const entry={ id:uuid(), name:S.name||'Jogador', correct:S.correct, total, score:S.score, time:Math.max(0,S.time), prize:prizeFor(S.correct,total), ts:Date.now() };
    const board=addToBoard(entry);

    $('#resultTitle').textContent=title; $('#hits').textContent=`${S.correct}/${total}`; $('#finalScore').textContent=pad4(S.score); $('#prizeBox').textContent=`Brinde: ${entry.prize}`;
    show('result');

    renderBoard('#boardTableSide'); /* atualiza ranking lateral */
    const pos=findPlacement(entry,board); $('#playerPlacement').textContent=pos?`Sua posição: #${pos}`:'Continue tentando!';
  }

  /* feedback (dica) grande + piscando */
  function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; t.setAttribute('role','status'); t.setAttribute('aria-live','polite'); document.body.appendChild(t); setTimeout(()=>t.remove(),1500); }

  /* leaderboard local */
  function loadBoard(){ try{return JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.BOARD)||'[]')}catch{return[]} }
  function saveBoard(list){ localStorage.setItem(CONFIG.STORAGE_KEYS.BOARD, JSON.stringify(list)); }
  function addToBoard(entry){ const list=loadBoard(); list.push(entry); list.sort((a,b)=>(b.score-a.score)||(b.time-a.time)); const trimmed=list.slice(0,CONFIG.BOARD_SIZE); saveBoard(trimmed); return trimmed; }
  function renderBoard(sel){ const list=loadBoard(); const t=$(sel); if(!t) return; if(!list.length){ t.innerHTML=`<tr><td style="padding:12px">Sem resultados ainda.</td></tr>`; return; } let rows=`<tr><th>#</th><th>Nome</th><th>Acertos</th><th>Score</th><th>Tempo</th><th>Quando</th></tr>`; rows+=list.map((r,i)=>`<tr><td>${i+1}</td><td>${r.name.replace(/[&<>"']/g,'')}</td><td>${r.correct}/${r.total}</td><td>${pad4(r.score)}</td><td>${r.time}s</td><td>${new Date(r.ts).toLocaleString()}</td></tr>`).join(''); t.innerHTML=rows; }
  function findPlacement(entry,list){ for(let i=0;i<list.length;i++){ if(list[i].id===entry.id) return i+1; } return null; }

  /* controles */
  const nameInput=$('#playerName');
  nameInput.addEventListener('input',()=>{ const v=(nameInput.value||'').trim(); $('#btnStart').disabled=v.length===0; S.name=v||'Jogador'; });
  function clearName(){ nameInput.value=''; nameInput.placeholder='Seu nome'; $('#btnStart').disabled=true; S.name='Jogador'; }

  $('#btnStart').addEventListener('click',e=>{e.preventDefault();startGame();});
  $('#btnAgain').addEventListener('click',e=>{e.preventDefault();show('start'); clearName(); renderBoard('#boardTableSide');});
  $('#btnFull').addEventListener('click',()=>{ const el=document.documentElement; const fn=el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen; if(fn) fn.call(el); });
  $('#btnMute').addEventListener('click',()=>{ S.muted=!S.muted; $('#btnMute').textContent=S.muted?'🔇':'🔊'; $('#btnMute').setAttribute('aria-pressed', String(!S.muted)); });
  $('#btnReset').addEventListener('click',()=>{ clearInterval(S.ticking); show('start'); clearName(); });
  $('#btnGuide').addEventListener('click',()=>{ const g=$('#guide'); g.style.display=(g.style.display==='none'?'block':'none'); });

  /* botão Ver Ranking: alterna sidebar no mobile (no desktop já está visível) */
  const side = document.getElementById('sidebar');
  $('#btnViewBoard').addEventListener('click', ()=>{
    if (getComputedStyle(side).display === 'none') { side.style.display = 'block'; side.scrollIntoView({behavior:'smooth', block:'start'}); }
    else if (matchMedia('(max-width:1099px)').matches) { side.style.display = 'none'; }
  });

  $('#btnClearBoard').addEventListener('click',()=>{ if(confirm('Limpar ranking local?')){ localStorage.setItem(CONFIG.STORAGE_KEYS.BOARD,'[]'); renderBoard('#boardTableSide'); $('#playerPlacement').textContent='—'; } });

  /* temas */
  const themeSel=$('#themeSel');
  function applyTheme(val){ document.body.classList.remove('theme-contrast','theme-cvd'); if(val==='contrast') document.body.classList.add('theme-contrast'); if(val==='cvd') document.body.classList.add('theme-cvd'); localStorage.setItem(CONFIG.STORAGE_KEYS.THEME,val); }
  themeSel.addEventListener('change',e=>applyTheme(e.target.value));
  (function bootTheme(){ const saved=localStorage.getItem(CONFIG.STORAGE_KEYS.THEME)||'default'; themeSel.value=saved; applyTheme(saved); })();

  /* boot */
  document.addEventListener('DOMContentLoaded',()=>{
    show('start'); updateTimerUI(true); renderBoard('#boardTableSide'); startBg();
    if('serviceWorker' in navigator){ addEventListener('load',()=>navigator.serviceWorker.register('/sw.js').catch(console.error)); }
  });
</script>
</body>
</html>
